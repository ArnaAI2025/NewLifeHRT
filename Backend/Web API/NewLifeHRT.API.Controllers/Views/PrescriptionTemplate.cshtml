@using System.Globalization
@{
    var usdCulture = new CultureInfo("en-US");

    var textPositions = new[] { "left", "center", "right" };
    var randomIndex = Math.Abs(Guid.NewGuid().GetHashCode()) % textPositions.Length;
    var randomTextAlign = textPositions[randomIndex];

    var isSchedule = Model.IsScheduleDrug == true;
    var totalPages = isSchedule && Model.OrderDetails != null ? Model.OrderDetails.Count() : 1;
}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prescription</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 9pt;
            line-height: 1.4;
            color: #000;
            background: #fff;
            margin: 0;
        }

        /* ===== PAGE STRUCTURE FOR SCHEDULED DRUGS ===== */
        .page {
            page-break-after: always;
            padding: 20px 30px;
            min-height: 100vh;
            position: relative;
        }

            .page:last-child {
                page-break-after: auto;
            }

        /* ===== NON-SCHEDULED CONTAINER ===== */
        .container {
            padding: 20px 30px;
        }

        /* ===== HEADER ===== */
        .header {
            display: table;
            width: 100%;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #000;
        }

        .doctor-info {
            display: table-cell;
            vertical-align: top;
            width: 55%;
            padding-right: 20px;
        }

            .doctor-info .name {
                font-weight: bold;
                font-size: 10pt;
                margin-bottom: 3px;
            }

            .doctor-info div {
                margin-bottom: 1px;
            }

        .header-right {
            display: table-cell;
            vertical-align: top;
            text-align: left;
            width: 45%;
        }

            .header-right div {
                margin-bottom: 1px;
            }

        .label {
            font-weight: bold;
        }

        /* ===== PATIENT + SHIPPING ===== */
        .patient-shipping-section {
            display: table;
            width: 100%;
            margin: 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #000;
        }

        .patient-info {
            display: table-cell;
            vertical-align: top;
            width: 50%;
            padding-right: 20px;
        }

            .patient-info div {
                margin-bottom: 1px;
            }

        .shipping-info {
            display: table-cell;
            vertical-align: top;
            width: 50%;
            text-align: left;
        }

            .shipping-info div {
                margin-bottom: 1px;
            }

        /* ===== PRESCRIPTION ITEMS ===== */
        .prescription-items {
            margin: 20px 0;
            min-height: 200px;
        }

        .prescription-item {
            margin-bottom: 15px;
        }

        .product-name {
            font-weight: normal;
            font-size: 9pt;
            margin-bottom: 2px;
        }

        .product-quantity {
            margin-bottom: 2px;
            font-size: 9pt;
        }

        .product-details {
            white-space: pre-line;
            margin: 2px 0 8px 0;
            line-height: 1.4;
            font-size: 9pt;
        }

        .no-details {
            color: #666;
            margin: 20px 0;
            font-style: italic;
        }

        /* ===== FOOTER ===== */
        .footer-section {
            margin-top: 30px;
            padding-top: 10px;
        }

        .refills-section {
            font-size: 9pt;
            margin-bottom: 8px;
        }

        .signature-section {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .signature-label {
            width: 20%;
            font-size: 9pt;
        }

        .signature-image-container {
            display: flex;
            align-items: center;
            width: 80%;
        }

            .signature-image-container img {
                max-width: 180px;
                max-height: 50px;
                display: block;
            }

        .page-number {
            text-align: center;
            font-size: 8pt;
            margin-top: 20px;
            color: #666;
        }

        @@media print {
            .page {
                padding: 20px 30px;
                min-height: 100vh;
            }

            .container {
                padding: 20px 30px;
            }
        }
    </style>
</head>
<body>
    @if (isSchedule && Model.OrderDetails != null && Model.OrderDetails.Any())
    {
        @* SCHEDULED DRUG: Each item on separate page with repeated header/footer *@
        var pageNumber = 0;
        foreach (var detail in Model.OrderDetails)
        {
            pageNumber++;
            <div class="page">
                <!-- ======= HEADER ======= -->
                <div class="header">
                    <div class="doctor-info">
                        <div class="name">@(Model.DoctorName ?? "-")</div>
                        <div><span class="label">DEA#:</span> @(Model.DrivingLicence ?? "-")</div>
                        @if (!string.IsNullOrEmpty(Model.Description))
                        {
                            <div>@Model.Description</div>
                        }
                        @if (Model.DoctorShippingAddress != null)
                        {
                                <div>@Model.DoctorShippingAddress.AddressLine1</div>
                                <div>@Model.DoctorShippingAddress.City @Model.DoctorShippingAddress.StateOrProvince @Model.DoctorShippingAddress.PostalCode</div>
                        }
                        <div><span class="label">Phone:</span> @(Model.PhoneNumber ?? "-")</div>
                    </div>
                    <div class="header-right">
                        <div><span class="label">Date:</span> @(Model.CreatedAt.ToString("MM/dd/yyyy"))</div>
                        <div><span class="label">License:</span> @(Model.LicenseNumber)</div>
                        <div><span class="label">Last office visit:</span> @(Model.LastOfficeVisit?.ToString("MM/dd/yyyy") ?? "-")</div>
                    </div>

                </div>

                <!-- ======= PATIENT & SHIPPING INFO ======= -->
                <div class="patient-shipping-section">
                    <div class="patient-info">
                        <div><span class="label">Patient Name:</span> @Model.PatientName</div>
                        @if (Model.PatientShippingAddress != null)
                        {
                                <div>@Model.PatientShippingAddress.AddressLine1</div>
                                <div>@Model.PatientShippingAddress.City @Model.PatientShippingAddress.StateOrProvince @Model.PatientShippingAddress.PostalCode</div>
                        }
                        <div>@Model.PatientShippingAddress.Country</div>
                        <div><span class="label">DOB:</span> @(Model.DateOfBirth?.ToString("MM/dd/yyyy") ?? "-")</div>
                        <div><span class="label">Phone:</span> @(Model.PhoneNumber ?? "-")</div>
                        <div><span class="label">DL#:</span> @(Model.DrivingLicence ?? "-")</div>
                        <div><span class="label">Allergies:</span> @(Model.Allergies ?? "NKA")</div>
                    </div>

                    <div class="shipping-info">
                        <div><span class="label">SHIP TO</span> @Model.PatientName</div>
                        <div><span class="label">Shipping Method:</span> @(Model.ShippingMethodName ?? "-")</div>
                        <div><span class="label">Signature required:</span>No</div>
                        @if (Model.PatientShippingAddress != null)
                        {
                                <div><span class="label">Shipping Address:</span> @Model.PatientShippingAddress.AddressLine1</div>
                                <div>@Model.PatientShippingAddress.City @Model.PatientShippingAddress.StateOrProvince @Model.PatientShippingAddress.PostalCode</div>
                        }
                    </div>
                </div>

                <!-- ======= PRESCRIPTION ITEM ======= -->
                <div class="prescription-items">
                    <div class="prescription-item">
                        <div class="product-name">@(detail.ProductName ?? "Product")</div>
                        <div class="product-quantity"># @detail.Quantity</div>
                        <div class="product-details">
                            @if (!string.IsNullOrEmpty(detail.Protocol))
                            {
                                @detail.Protocol
                            }
                            else if (!string.IsNullOrEmpty(detail.ProductType))
                            {
                                @detail.ProductType
                            }
                            else
                            {
                                <text>No instructions provided</text>
                            }
                        </div>
                    </div>
                </div>

                <!-- ======= FOOTER ======= -->
                <div class="footer-section">
                    <div class="refills-section">0 Refills</div>
                    <div style="width:100%; margin-top:10px;">
                        <div style="font-size:9pt; margin-bottom:5px;">Signature</div>
                        <div style="width:100%; text-align:@randomTextAlign;">
                            @if (!string.IsNullOrEmpty(Model.Signature))
                            {
                                <img src="@Model.Signature" alt="Signature" style="max-width:180px; max-height:50px;" />
                            }
                            else
                            {

                                <div>&nbsp;</div>
                            }
                        </div>
                    </div>
                    <div class="page-number">Page @pageNumber of @totalPages</div>
                </div>

                <div class="page-number">Page @pageNumber of @totalPages</div>
            </div>
        }
    }
    else
    {
        @* NON-SCHEDULED DRUG: All items on single page *@
        <div class="container">
            <!-- ======= HEADER ======= -->
            <div class="header">
                <div class="doctor-info">
                    <div class="name">@(Model.DoctorName ?? "-")</div>
                    <div><span class="label">DEA#:</span> @(Model.DrivingLicence ?? "-")</div>
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <div>@Model.Description</div>
                    }
                    @if (Model.DoctorShippingAddress != null)
                    {
                            <div>@Model.DoctorShippingAddress.AddressLine1</div>
                            <div>@Model.DoctorShippingAddress.City @Model.DoctorShippingAddress.StateOrProvince @Model.DoctorShippingAddress.PostalCode</div>
                    }
                    <div><span class="label">Phone:</span> @(Model.PhoneNumber ?? "-")</div>
                </div>
                <div class="header-right">
                    <div><span class="label">Date:</span> @(Model.CreatedAt.ToString("MM/dd/yyyy"))</div>
                    <div><span class="label">License:</span> @(Model.LicenseNumber)</div>
                    <div><span class="label">Last office visit:</span> @(Model.LastOfficeVisit?.ToString("MM/dd/yyyy") ?? "-")</div>
                </div>
            </div>

            <!-- ======= PATIENT & SHIPPING INFO ======= -->
            <div class="patient-shipping-section">
                <div class="patient-info">
                    <div><span class="label">Patient Name:</span> @Model.PatientName</div>
                    @if (Model.PatientShippingAddress != null)
                    {
                            <div>@Model.PatientShippingAddress.AddressLine1</div>
                            <div>@Model.PatientShippingAddress.City @Model.PatientShippingAddress.StateOrProvince @Model.PatientShippingAddress.PostalCode</div>
                    }
                    <div>@Model.PatientShippingAddress.Country</div>
                    <div><span class="label">DOB:</span> @(Model.DateOfBirth?.ToString("MM/dd/yyyy") ?? "-")</div>
                    <div><span class="label">Phone:</span> @(Model.PhoneNumber ?? "-")</div>
                    <div><span class="label">DL#:</span> @(Model.DrivingLicence ?? "-")</div>
                    <div><span class="label">Allergies:</span> @(Model.Allergies ?? "NKA")</div>
                </div>

                <div class="shipping-info">
                    <div><span class="label">SHIP TO</span> @Model.PatientName</div>
                    <div><span class="label">Shipping Method:</span> @(Model.ShippingMethodName ?? "-")</div>
                    <div><span class="label">Signature required:</span>No</div>
                    @if (Model.PatientShippingAddress != null)
                    {
                            <div><span class="label">Shipping Address:</span> @Model.PatientShippingAddress.AddressLine1</div>
                            <div>@Model.PatientShippingAddress.City @Model.PatientShippingAddress.StateOrProvince @Model.PatientShippingAddress.PostalCode</div>
                    }
                </div>
            </div>

            <!-- ======= PRESCRIPTION ITEMS ======= -->
            @if (Model.OrderDetails != null && Model.OrderDetails.Any())
            {
                <div class="prescription-items">
                    @foreach (var detail in Model.OrderDetails)
                    {
                        <div class="prescription-item">
                            <div class="product-name">@(detail.ProductName ?? "Product")</div>
                            <div class="product-quantity"># @detail.Quantity</div>
                            <div class="product-details">
                                @if (!string.IsNullOrEmpty(detail.Protocol))
                                {
                                    @detail.Protocol
                                }
                                else if (!string.IsNullOrEmpty(detail.ProductType))
                                {
                                    @detail.ProductType
                                }
                                else
                                {
                                    <text>No instructions provided</text>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="no-details">No prescription details available.</div>
            }

            <!-- ======= FOOTER ======= -->
            <div class="footer-section">
                <div class="refills-section">0 Refills</div>
                <div style="width:100%; margin-top:10px;">
                    <div style="font-size:9pt; margin-bottom:5px;">Signature</div>
                    <div style="width:100%; text-align:@randomTextAlign;">
                        @if (!string.IsNullOrEmpty(Model.Signature))
                        {
                            <img src="@Model.Signature" alt="Signature" style="max-width:180px; max-height:50px;" />
                        }
                        else
                        {

                            <div>&nbsp;</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</body>
</html>