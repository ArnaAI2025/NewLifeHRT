<div
  class="flex flex-wrap items-center justify-between sticky top-0 z-10 rounded-md shadow-sm mb-4 bg-white overflow-hidden py-2 px-4">
  <div class="flex items-center space-x-2">
    <button mat-icon-button class="header-back-button" (click)="goBack()">
      <mat-icon>chevron_left</mat-icon>
    </button>
    <span class="form-header-heading">Booking for Holiday</span>
  </div>
</div>

<form class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 bg-card-color" #holidayForm="ngForm"
  (ngSubmit)="submit(holidayForm)">
  <div>
    <h2 class="text-sm font-medium text-gray-500">User Details</h2>
    <div class="mt-3">
      <label class="block text-xs text-gray-500 mb-1" for="selectUser">Select User <span
          class="text-red-500">*</span></label>
      <div class="relative">
        <select id="selectUser" #userSelect="ngModel" name="userSelect" required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 pr-10 text-sm
               focus:border-blue-500 focus:outline-none appearance-none" [(ngModel)]="selectedUser">
          <option [ngValue]="null">-- Select a User --</option>
          <option *ngFor="let u of users()" [ngValue]="u.id">{{ u.value }}</option>
        </select>
        <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </span>
      </div>
      <div *ngIf="userSelect.invalid && (userSelect.touched || submitted)" class="text-red-500 text-xs mt-1">
        Please select a user
      </div>
    </div>
  </div>

  <div class="border-t border-gray-200"></div>

  <div>
    <h2 class="text-sm font-medium text-gray-500 pt-5">Leave Details</h2>
    <div class="mt-3">
      <label class="block text-xs text-gray-500 mb-1" for="leaveType">Select Leave Type <span
          class="text-red-500">*</span></label>
      <div class="relative">
        <select id="leaveType" #leaveTypeSelect="ngModel" name="leaveTypeSelect" required
          class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 pr-10 text-sm focus:border-blue-500 focus:outline-none appearance-none"
          [(ngModel)]="leaveType">
          <option value="custom">Custom Date</option>
          <option value="recurrence">Recurrence</option>
        </select>
        <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </span>
      </div>
    </div>
  </div>

  <div class="border-t border-gray-200"></div>

  <ng-container *ngIf="leaveType==='custom'">
    <div class="space-y-4">
      <h3 class="text-sm font-medium text-gray-500 pt-5">Custom Dates</h3>
      <p class="text-xs text-gray-500">Select one or multiple dates. Then set the time for each date. You can also
        apply one time range to all selected dates.</p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="border border-gray-200 rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <button type="button" class="p-2 rounded hover:bg-gray-50 focus:outline-none" (click)="changeMonth(-1)"
              aria-label="Previous Month">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <div class="text-sm font-semibold text-gray-700">{{ monthLabel }}</div>
            <button type="button" class="p-2 rounded hover:bg-gray-50 focus:outline-none" (click)="changeMonth(1)"
              aria-label="Next Month">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
          <div class="grid grid-cols-7 text-center text-xs text-gray-500 mb-2">
            <div>Sunday</div>
            <div>Monday</div>
            <div>Tuesday</div>
            <div>Wednesday</div>
            <div>Thursday</div>
            <div>Friday</div>
            <div>Saturday</div>
          </div>
          <div class="grid grid-cols-7 gap-2 text-sm">
            <div *ngFor="let _ of blanks" class="text-center py-2 text-gray-300">&nbsp;</div>
            <button type="button" *ngFor="let d of days" (click)="toggleDate(d)" [disabled]="isPastDate(d)" [ngClass]="
    isPastDate(d)
      ? 'text-center py-2 rounded-lg border border-gray-200 text-gray-400 cursor-not-allowed'
      : isSelected(d)
        ? 'text-center py-2 rounded-lg border border-blue-400 bg-blue-50 text-blue-700'
        : 'text-center py-2 rounded-lg border border-transparent hover:border-blue-300 hover:bg-blue-50'
  ">
              {{ d }}
            </button>
          </div>
        </div>

        <div>
          <label class="block text-xs text-gray-500 mb-1">Selected Dates</label>
          <div class="min-h-[2.25rem] flex flex-wrap gap-2">
            <span *ngFor="let key of selectedKeysSorted"
              class="inline-flex items-center gap-1 rounded-full border border-blue-200 bg-blue-50 text-blue-700 px-2.5 py-1 text-xs">
              {{ formatDate(key) }}
              <button type="button" class="font-bold leading-none" (click)="removeDate(key)">Ã—</button>
            </span>
          </div>

          <div *ngIf="selectedKeysSorted.length>0" class="mt-4 border border-gray-200 rounded-lg p-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs text-gray-500 mb-1" for="bulkStart">Bulk Start Time</label>
                <input id="bulkStart" type="time"
                  class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none"
                  [(ngModel)]="bulkStart" name="bulkStart" />
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-1" for="bulkEnd">Bulk End Time</label>
                <input id="bulkEnd" type="time"
                  class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none"
                  [(ngModel)]="bulkEnd" name="bulkEnd" />
              </div>
            </div>
            <div class="flex justify-between mt-2">
              <button type="button" class="text-xs text-gray-500 hover:underline" (click)="clearAll()">Clear
                all</button>
              <button type="button" class="text-xs text-blue-600 hover:underline" (click)="applyToAll()">Apply to
                All Dates</button>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="submitted && selectedKeysSorted.length === 0" class="text-red-500 text-xs mt-1">
        Please select at least one date
      </div>

      <div *ngIf="selectedKeysSorted.length>0">
        <h4 class="text-sm font-medium text-gray-500 mb-2">Times per Date</h4>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <div *ngFor="let key of selectedKeysSorted" class="rounded-xl border border-gray-200 p-4">
            <p class="text-sm font-semibold text-gray-800 mb-2">Date: {{ formatDate(key) }}</p>
            <div class="space-y-2">
              <div>
                <label class="block text-xs text-gray-500 mb-1">Start Time <span class="text-red-500">*</span></label>
                <input type="time"
                  class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none"
                  [(ngModel)]="dateTimes[key].start" #startTime="ngModel" name="startTime_{{key}}" required />
                <div *ngIf="startTime.invalid && (startTime.touched || submitted)" class="text-red-500 text-xs mt-1">
                  Start time is required
                </div>
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-1">End Time <span class="text-red-500">*</span></label>
                <input type="time"
                  class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none"
                  [(ngModel)]="dateTimes[key].end" #endTime="ngModel" name="endTime_{{key}}" required />
                <div *ngIf="endTime.invalid && (endTime.touched || submitted)" class="text-red-500 text-xs mt-1">
                  End time is required
                </div>
                <div
                  *ngIf="submitted && dateTimes[key].start && dateTimes[key].end && dateTimes[key].start >= dateTimes[key].end"
                  class="text-red-500 text-xs mt-1">
                  End time must be after start time
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <label class="block text-xs text-gray-500 mb-1" for="customDesc">Description (optional)</label>
        <textarea id="customDesc" rows="4"
          class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none"
          [(ngModel)]="description" name="description" placeholder="Add any special requests"></textarea>
      </div>

      <div class="flex justify-end">
        <button type="submit"
          class="inline-flex items-center rounded-xl bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none">Apply
          Holiday</button>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="leaveType==='recurrence'">
    <div class="space-y-4">
      <h3 class="text-sm font-medium text-gray-500 pt-5">Recurrence</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-xs text-gray-500 mb-1" for="recStartDate">Select Start Date <span
              class="text-red-500">*</span></label>
          <input id="recStartDate" type="date" #startDate="ngModel" name="startDate" required
            class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none"
            [(ngModel)]="rec.startDate"
            [min]="todayString"/>
          <div *ngIf="startDate.invalid && (startDate.touched || submitted)" class="text-red-500 text-xs mt-1">
            Start date is required
          </div>
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1" for="recEndDate">Select End Date <span
              class="text-red-500">*</span></label>
          <input id="recEndDate" type="date"
            class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none"
            [(ngModel)]="rec.endDate" #endDate="ngModel" name="endDate" required [min]="todayString" />
          <div *ngIf="endDate.invalid && (endDate.touched || submitted)" class="text-red-500 text-xs mt-1">
            End date is required
          </div>
          <div *ngIf="submitted && rec.startDate && rec.endDate && rec.startDate > rec.endDate"
            class="text-red-500 text-xs mt-1">
            End date must be after start date
          </div>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-xs text-gray-500 mb-1" for="recStartTime">Select Start Time <span
              class="text-red-500">*</span></label>
          <input id="recStartTime" type="time" #startTime="ngModel" name="recStartTime" required
            class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none"
            [(ngModel)]="rec.startTime" />
          <div *ngIf="startTime.invalid && (startTime.touched || submitted)" class="text-red-500 text-xs mt-1">
            Start time is required
          </div>
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1" for="recEndTime">Select End Time <span
              class="text-red-500">*</span></label>
          <input id="recEndTime" type="time" #endTime="ngModel" name="recEndTime" required
            class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none"
            [(ngModel)]="rec.endTime" />
          <div *ngIf="endTime.invalid && (endTime.touched || submitted)" class="text-red-500 text-xs mt-1">
            End time is required
          </div>
          <div *ngIf="submitted && rec.startTime && rec.endTime && rec.startTime >= rec.endTime"
            class="text-red-500 text-xs mt-1">
            End time must be after start time
          </div>
        </div>
      </div>
      <div>
        <p class="block text-xs text-gray-500 mb-2">Select Recurrence Day <span class="text-red-500">*</span></p>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
          <button type="button" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm"
            [ngClass]="{'border-blue-500 bg-blue-50 text-blue-700': rec.days[1]}"
            (click)="rec.days[1]=!rec.days[1]">Monday</button>
          <button type="button" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm"
            [ngClass]="{'border-blue-500 bg-blue-50 text-blue-700': rec.days[2]}"
            (click)="rec.days[2]=!rec.days[2]">Tuesday</button>
          <button type="button" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm"
            [ngClass]="{'border-blue-500 bg-blue-50 text-blue-700': rec.days[3]}"
            (click)="rec.days[3]=!rec.days[3]">Wednesday</button>
          <button type="button" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm"
            [ngClass]="{'border-blue-500 bg-blue-50 text-blue-700': rec.days[4]}"
            (click)="rec.days[4]=!rec.days[4]">Thursday</button>
          <button type="button" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm"
            [ngClass]="{'border-blue-500 bg-blue-50 text-blue-700': rec.days[5]}"
            (click)="rec.days[5]=!rec.days[5]">Friday</button>
        </div>
        <div *ngIf="submitted && !hasRecurrenceDays()" class="text-red-500 text-xs mt-1">
          Please select at least one day
        </div>
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1" for="recDesc">Description (optional)</label>
        <textarea id="recDesc" rows="4"
          class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none"
          [(ngModel)]="description" name="description" placeholder="Add any special requests"></textarea>
      </div>
      <div class="flex justify-end">
        <button type="submit"
          class="inline-flex items-center rounded-xl bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none">Apply
          Holiday</button>
      </div>
    </div>
  </ng-container>
</form>
