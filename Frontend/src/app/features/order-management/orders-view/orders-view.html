<app-patient-navigation-bar *ngIf="patientId" [isEditMode]="true" [isSaving]="false" [isActive]="undefined"
    [patientId]="patientId" (close)="onClose()" [activeView]="'orders'" (save)="onSubmit()"
    (addPatient)="onClickAddPatient()" (saveAndClose)="onSaveAndClose()"
    (toggleActiveStatus)="togglePatientActiveStatus($event)">
</app-patient-navigation-bar>
<div class="relative">
    <!-- Header -->
    <div class="flex items-center justify-between flex-wrap gap-4 mb-6">
        <div class="flex items-center">
            <h1 class="list-page-heading">Orders</h1>
            <div class="flex items-center space-x-3 filter-input search-box search-box-dsk">
                <!-- Search Input -->
                <div class="relative ml-6">
                    <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
                    <input matInput type="text" placeholder="Filter by keywords" [(ngModel)]="searchKeyword"
                        (input)="applyFilter()" [disabled]="isLoading()"
                        class="pl-10 text-left pr-4 py-2 border border-gray-300 rounded-md  w-64 disabled:bg-gray-100 disabled:cursor-not-allowed" />
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4 justify-end ml-auto">
            <div *ngIf="getSelectedCount() > 0"
                class="p-2 bg-blue-50 border border-blue-200 rounded-md flex items-center justify-between">
                <div class="flex items-center">
                    <mat-icon class="text-blue-600 mr-2">info</mat-icon>
                    <span class="text-blue-800">{{ getSelectedCount() }} Order{{
                        getSelectedCount() > 1 ? 's' : '' }} selected</span>
                </div>
            </div>
            <!-- Add Order Button -->

            <!-- currently on hold from client side -->

            <!-- <button mat-flat-button (click)="onAddOrder()" [disabled]="isLoading()"
                class="flex items-center text-blue-600 primary-btn-add">
                <mat-icon class="mr-1">add</mat-icon> Add Order
            </button> -->

            <!-- Bulk Action Menu -->
            <button type="button" [matMenuTriggerFor]="bulkMenu" [disabled]="getSelectedCount() < 1"
                class="secondry-button-add px-2 rounded-md flex items-center gap-1"
                [ngClass]="{'disabled': getSelectedCount() < 1}">
                <span class="hidden sm:inline">Bulk Action</span>
                <mat-icon>keyboard_arrow_down</mat-icon>
            </button>
            <mat-menu #bulkMenu="matMenu">
                <button mat-menu-item (click)="onBulkDelete()" class="text-red-600">
                    <span>Delete</span>
                </button>
            </mat-menu>
        </div>
        <div class="flex items-center space-x-3 w-full filter-input search-box-mb">
            <!-- Search Input -->
            <div class="relative">
                <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
                <input matInput type="text" placeholder="Filter by keywords" [(ngModel)]="searchKeyword"
                    (input)="applyFilter()" [disabled]="isLoading()"
                    class="pl-10 text-left pr-4 py-2 border border-gray-300 rounded-md w-full bg-transparent disabled:bg-transparent disabled:opacity-50 disabled:cursor-not-allowed !bg-transparent" />
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div *ngIf="isLoading() || isDeleting()"
        class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 rounded-lg">
        <mat-spinner diameter="40"></mat-spinner>
    </div>

    <!-- Table -->
    <div class="table-container custom-table-view" [class.opacity-50]="isLoading() || isDeleting()"
        [class.pointer-events-none]="isLoading() || isDeleting()">
        <table mat-table [dataSource]="dataSource" matSort class="w-full custom-table mat-elevation-z0">

            <!-- Select Checkbox -->
            <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef
                    class="!text-left !py-3 !px-4 rounded-tl-lg rounded-bl-lg font-medium text-gray-700">
                    <mat-checkbox (change)="$event ? masterToggle() : null" class="custom-mat-checkbox"
                        [checked]="isAllSelected()" [indeterminate]="selection.hasValue() && !isAllSelected()"
                        [disabled]="dataSource.filteredData.length === 0"></mat-checkbox>
                </th>
                <td mat-cell *matCellDef="let row" class="!pl-6">
                    <mat-checkbox (click)="$event.stopPropagation()" class="custom-mat-checkbox"
                        (change)="toggleRowSelection(row)" [checked]="isSelected(row)"
                        [disabled]="isLoading() || isDeleting() || row.status === OrderStatus.LifeFileProcessing"></mat-checkbox>
                </td>
            </ng-container>

            <!-- Name -->
            <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
                <td mat-cell *matCellDef="let row">
                    <span class="primary-text-color hover:underline cursor-pointer font-medium" (click)="onEdit(row)">
                        {{ row.name }}
                    </span>
                </td>
            </ng-container>

            <!-- Patient Name -->
            <ng-container matColumnDef="patientName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Patient Name</th>
                <td mat-cell *matCellDef="let row">{{ row.patientName }}</td>
            </ng-container>

            <!-- Pharmacy Name -->
            <ng-container matColumnDef="pharmacyName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Pharmacy Name</th>
                <td mat-cell *matCellDef="let row">{{ row.pharmacyName }}</td>
            </ng-container>

            <!-- Assigned User Name -->
            <ng-container matColumnDef="assignedUserName">
                <th mat-header-cell *matHeaderCellDef>Assigned User Name</th>
                <td mat-cell *matCellDef="let row">{{ row.assignedUserName }}</td>
            </ng-container>

            <!-- Counselor Name -->
            <ng-container matColumnDef="counselorName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Counselor Name</th>
                <td mat-cell *matCellDef="let row">{{ row.counselorName }}</td>
            </ng-container>

            <!-- Therapy Expiration -->
            <ng-container matColumnDef="therapyExpiration">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Therapy Expiration</th>
                <td mat-cell *matCellDef="let row">
                    <span
                        [ngClass]="{ 'text-red-600 font-semibold': isTherapyExpired(row.therapyExpiration), 'text-gray-700': !isTherapyExpired(row.therapyExpiration) }">
                        {{ getFormattedDate(row.therapyExpiration) }}
                    </span>
                </td>
            </ng-container>

            <!-- Status -->
            <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
                <td mat-cell *matCellDef="let row">
                    <span class="px-2 py-1 rounded-full text-sm font-semibold primary-text-color"
                        [ngClass]="getOrderStatusClass(row.status)">
                        {{ getOrderStatusText(row.status) }}
                    </span>
                </td>
            </ng-container>

            <!-- Actions -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="text-center rounded-tr-xl rounded-br-xl">Actions</th>
                <td mat-cell *matCellDef="let row" class="text-center">
                    <button mat-icon-button [matMenuTriggerFor]="actionMenu" (click)="activeRow = row"
                        [disabled]="isLoading() || isDeleting()">
                        <mat-icon>more_vert</mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true" class="bg-gray-50"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns" [class.selected]="isSelected(row)"></tr>

        </table>
    </div>

    <!-- No Data -->
    <div class="text-center py-8 " *ngIf="!dataSource.filteredData.length && !isLoading()">
        <mat-icon class="text-gray-400 text-4xl mb-2">person_off</mat-icon>
        <p class="text-gray-500" *ngIf="searchKeyword">No results for "{{searchKeyword}}"</p>
        <p class="text-gray-500" *ngIf="!searchKeyword">No order data available</p>
    </div>

    <!-- mobile view table card -->
    <div class="mobile-table-wapper pb-4">
        <ng-container *ngIf="dataSource.filteredData.length > 0">
            <div class="flex items-center gap-2">
                <mat-checkbox class="custom-mat-checkbox" (change)="$event ? masterToggle() : null"
                    [checked]="isAllSelected()"
                    [indeterminate]="selection.hasValue() && !isAllSelected()"></mat-checkbox>
                <span class="font-bold">Details</span>
            </div>
            <div class="mobile-view-table" *ngFor="let element of pagedData">
                <div class="toggle-table flex items-center gap-4">
                    <div>
                        <mat-checkbox class="custom-mat-checkbox" (change)="toggleRowSelection(element)"
                            [checked]="isSelected(element)" [disabled]="isLoading()"></mat-checkbox>
                    </div>
                    <div>
                        <p class="m-0"><span class="user-name"
                                (click)="onEdit(element)">{{element.name}}</span>({{getOrderStatusText(element.status)
                            }})</p>
                        <p class="m-0">{{element.patientName}}</p>
                        <p class="m-0">{{element.pharmacyName}}</p>
                    </div>
                </div>
                <div>
                    <button mat-icon-button [matMenuTriggerFor]="actionMenu" (click)="activeRow = element">
                        <mat-icon>more_vert</mat-icon>
                    </button>
                </div>
            </div>
        </ng-container>
    </div>

    <!-- <mat-paginator *ngIf="!isLoading() && dataSource.filteredData.length !== 0" #paginator [length]="dataSource.filteredData.length" [pageSize]="10" [pageSizeOptions]="[5, 10, 20]"
        showFirstLastButtons [disabled]="isLoading() || isDeleting"></mat-paginator> -->
    <div class="main-paginator">
        <div class="paginator-section p-0">
            <mat-paginator #paginator [pageSizeOptions]="[50, 100, 250, 500]" [pageSize]="100"
                [showFirstLastButtons]="true" [length]="dataSource.filteredData.length || 0" [disabled]="isLoading()"
                class="mat-mdc-paginator-container">
            </mat-paginator>
        </div>
    </div>
</div>


<!-- Action Menu -->
<mat-menu #actionMenu="matMenu">
    <button mat-menu-item (click)="onEdit(activeRow)">
        <span>Edit</span>
    </button>
    <button *ngIf="activeRow?.status !== OrderStatus.LifeFileProcessing" mat-menu-item (click)="onDelete(activeRow)"
        class="text-red-600">
        <span>Delete</span>
    </button>
</mat-menu>