<div class="card-color rounded-lg shadow-sm border border-gray-200 p-6">
    <!-- Header -->
    <div class="flex items-center flex-wrap gap-4 justify-between mb-6">
      <div class="flex items-center gap-4">
          <h2 class="list-page-heading">Proposals</h2>
          <div class="flex items-center space-x-3 filter-input search-box search-box-dsk">
              <!-- Search Input -->
              <div class="relative">
                  <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
                  <input matInput type="text" placeholder="Filter by keywords" [(ngModel)]="searchKeyword"
                      (input)="applyFilter()" [disabled]="isLoading()"
                      class="pl-10 text-left pr-4 py-2 border border-gray-300 rounded-md  w-64 disabled:bg-gray-100 disabled:cursor-not-allowed" />
              </div>
          </div>
      </div>
      <div class="flex items-center space-x-3 w-full filter-input search-box-mb">
        <!-- Search Input -->
        <div class="relative">
          <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
          <input matInput type="text" placeholder="Filter by keywords" [(ngModel)]="searchKeyword" (input)="applyFilter()"
            [disabled]="isLoading()"
            class="pl-10 text-left pr-4 py-2 border border-gray-300 rounded-md w-full bg-transparent disabled:bg-transparent disabled:opacity-50 disabled:cursor-not-allowed !bg-transparent"/>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div *ngIf="isLoading()"
        class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 rounded-lg">
        <mat-spinner diameter="40"></mat-spinner>
    </div>

    <!-- Table -->
    <div class="relative overflow-x-auto custom-table-view" [class.opacity-50]="isLoading()" [class.pointer-events-none]="isLoading()">
      <table mat-table [dataSource]="dataSource" matSort class="w-full custom-table">
          <!-- Name -->
          <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                  class="!text-left !py-3 !px-4 rounded-tl-lg rounded-bl-lg font-medium text-gray-700">Name</th>
              <td mat-cell *matCellDef="let row">
                  <span class="primary-text-color hover:underline cursor-pointer font-medium" (click)="onEdit(row)">
                      {{ row.name }}
                  </span>
              </td>
          </ng-container>

          <!-- Patient Name -->
          <ng-container matColumnDef="patientName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Patient Name</th>
              <td mat-cell *matCellDef="let row">{{ row.patientName }}</td>
          </ng-container>

          <!-- Pharmacy Name -->
          <ng-container matColumnDef="pharmacyName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Pharmacy Name</th>
              <td mat-cell *matCellDef="let row">{{ row.pharmacyName }}</td>
          </ng-container>

          <!-- Counselor Name -->
          <ng-container matColumnDef="counselorName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Counselor Name</th>
              <td mat-cell *matCellDef="let row">{{ row.counselorName }}</td>
          </ng-container>

          <!-- Therapy Expiration -->
          <ng-container matColumnDef="therapyExpiration">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Therapy Expiration</th>
              <td mat-cell *matCellDef="let row">
                  <span [ngClass]="{
          'text-red-600 font-semibold': isTherapyExpired(row.therapyExpiration),
          'text-gray-700': !isTherapyExpired(row.therapyExpiration)
        }">
                      {{ getFormattedDate(row.therapyExpiration) }}
                  </span>
              </td>
          </ng-container>

          <!-- Status (Proposal Status) -->
          <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
              <td mat-cell *matCellDef="let row">
                  <span class="px-2 py-1 rounded-full text-sm font-semibold"
                      [ngClass]="getProposalStatusClass(row.status)">
                      {{ getStatusDisplayText(row.status) }}
                  </span>
              </td>
          </ng-container>

          <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="text-center rounded-tr-xl rounded-br-xl">Actions</th>
              <td mat-cell *matCellDef="let row" class="text-center">
                <button mat-icon-button [matMenuTriggerFor]="actionMenu" (click)="activeRow = row"
                  [disabled]="isLoading() || isDeleting()">
                  <mat-icon>more_vert</mat-icon>
                </button>
              </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns" class="!bg-gray-50/50"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              class="hover:bg-gray-50/50 transition-colors !border-b !border-gray-100"></tr>
      </table>

      <!-- No Data -->
      <div class="text-center py-8 " *ngIf="!dataSource.filteredData.length && !isLoading()">
        <mat-icon class="text-gray-400 text-4xl mb-2">person_off</mat-icon>
        <p class="text-gray-500" *ngIf="searchKeyword">No results for "{{searchKeyword}}"</p>
        <p class="text-gray-500" *ngIf="!searchKeyword">No proposal data available</p>
      </div>
    </div>

     <!-- mobile view table card -->
  <div class="mobile-table-wapper pb-4">
    <ng-container *ngIf="dataSource.filteredData.length > 0">
      <div class="mobile-view-table" *ngFor = "let element of pagedData">
        <div class="toggle-table flex items-center gap-4">
          <div>
            <p class="m-0"><span class="user-name" (click)="onEdit(element)">{{element.name}}</span>({{ getStatusDisplayText(element.status) }})</p>
            <p class="m-0">{{element.patientName}}</p>
            <p class="m-0">{{element.pharmacyName}}</p>
          </div>
        </div>
        <div>
          <button mat-icon-button [matMenuTriggerFor]="actionMenu" (click)="activeRow = element" [disabled]="isLoading() || isDeleting()">
            <mat-icon>more_vert</mat-icon>
          </button>
        </div>
      </div>
    </ng-container>
    <div *ngIf="!isLoading() && dataSource.filteredData.length === 0" class="text-center py-12">
      <p class="text-gray-500" *ngIf="searchKeyword">No results for "{{searchKeyword}}"</p>
      <p class="text-gray-500" *ngIf="!searchKeyword">No proposals data available</p>
    </div>
  </div>
</div>

<!-- Paginator -->
<div class="main-paginator">
    <div class="paginator-section p-0">
        <mat-paginator #paginator [pageSizeOptions]="[5, 10, 20]" [pageSize]="5" [showFirstLastButtons]="true"
            [length]="dataSource.filteredData.length || 0" [disabled]="isLoading()">
        </mat-paginator>
    </div>
</div>

<!-- Action Menu -->
<mat-menu #actionMenu="matMenu">
  <button mat-menu-item (click)="onEdit(activeRow)">
    <span>Edit</span>
  </button>
  <button mat-menu-item (click)="onDelete(activeRow)" class="text-red-600">
    <span>Delete</span>
  </button>
</mat-menu>
