<app-patient-navigation-bar [isEditMode]="true" [isSaving]="false" [isActive]="undefined" [patientId]="patientId"
  (close)="onClose()" [activeView]="'counselor'" (save)="onSubmit()" (addPatient)="onClickAddPatient()"
  (saveAndClose)="onSaveAndClose()" (toggleActiveStatus)="togglePatientActiveStatus($event)">
</app-patient-navigation-bar>

<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 bg-card-color">
  <!-- Header -->
  <div class="flex items-center justify-between flex-wrap gap-4 mb-6 table-view-header mb-6">
    <div class="flex items-center">
      <h2 class="list-page-heading">Counselor Notes</h2>
      <div class="flex items-center space-x-3 filter-input search-box search-box-dsk">
        <div class="relative ml-6">
          <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
          <input matInput type="text" placeholder="Filter by keywords" [(ngModel)]="searchKeyword" (input)="applyFilter()"
            [disabled]="isLoading()"
            class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 w-64 text-left" />
        </div>
      </div>
    </div>
    <div class="flex items-center gap-4 justify-end ml-auto">
      <button mat-flat-button (click)="openAddNotePopup()" [disabled]="isLoading()"
        class="flex items-center text-blue-600 primary-btn-add">
        <mat-icon class="mr-1">add</mat-icon> Add Note
      </button>
    </div>
    <div class="flex items-center space-x-3 w-full filter-input search-box-mb">
        <!-- Search Input -->
        <div class="relative">
          <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
          <input matInput type="text" placeholder="Filter by keywords" [(ngModel)]="searchKeyword" (input)="applyFilter()"
            [disabled]="isLoading()"
            class="pl-10 text-left pr-4 py-2 border border-gray-300 rounded-md w-full bg-transparent disabled:bg-transparent disabled:opacity-50 disabled:cursor-not-allowed !bg-transparent" />

        </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="isLoading()"
    class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 rounded-lg">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Table Container -->
  <div class="relative overflow-x-auto custom-table-view" [class.opacity-50]="isLoading()"
    [class.pointer-events-none]="isLoading()">

    <table mat-table [dataSource]="dataSource" matSort class="w-full custom-table">

      <!-- Columns -->

      <!-- S. No -->
      <ng-container matColumnDef="sNo">
        <th mat-header-cell *matHeaderCellDef
          class="!text-xs !font-medium !text-gray-500 !pl-6 !w-16 rounded-tl-xl rounded-bl-xl">#</th>
        <td mat-cell *matCellDef="let row; let i = index" class="!text-sm !text-gray-600 !pl-6">
          {{ paginator.pageIndex * paginator.pageSize + i + 1 }}
        </td>
      </ng-container>

      <!-- Subject -->
      <ng-container matColumnDef="subject">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="!text-xs !font-medium !text-gray-500">Subject</th>
        <td mat-cell *matCellDef="let row" class="!text-sm !font-medium !text-gray-900">
          {{ row.subject }}
        </td>
      </ng-container>

      <!-- Note -->
      <ng-container matColumnDef="note">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="!text-xs !font-medium !text-gray-500">Note</th>
        <td mat-cell *matCellDef="let row" class="!text-sm !text-gray-600 !max-w-xs">
          <div class="truncate" [title]="row.note">{{ row.note }}</div>
        </td>
      </ng-container>

      <!-- Admin Mail Status -->
      <ng-container matColumnDef="isAdminMailSent">
        <th mat-header-cell *matHeaderCellDef class="!text-xs !font-medium !text-gray-500 !text-center">Admin</th>
        <td mat-cell *matCellDef="let row" class="!text-center">
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" [ngClass]="row.isAdminMailSent
            ? 'bg-green-50 text-green-700 ring-1 ring-green-600/20'
            : 'bg-red-50 text-red-700 ring-1 ring-red-600/20'">
            <span class="w-1.5 h-1.5 rounded-full mr-1.5"
              [ngClass]="row.isAdminMailSent ? 'bg-green-400' : 'bg-red-400'"></span>
            {{ row.isAdminMailSent ? 'Sent' : 'Not Sent' }}
          </span>
        </td>
      </ng-container>

      <!-- Doctor Mail Status -->
      <ng-container matColumnDef="isDoctorMailSent">
        <th mat-header-cell *matHeaderCellDef class="!text-xs !font-medium !text-gray-500 !text-center">Doctor</th>
        <td mat-cell *matCellDef="let row" class="!text-center">
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" [ngClass]="row.isDoctorMailSent
            ? 'bg-green-50 text-green-700 ring-1 ring-green-600/20'
            : 'bg-red-50 text-red-700 ring-1 ring-red-600/20'">
            <span class="w-1.5 h-1.5 rounded-full mr-1.5"
              [ngClass]="row.isDoctorMailSent ? 'bg-green-400' : 'bg-red-400'"></span>
            {{ row.isDoctorMailSent ? 'Sent' : 'Not Sent' }}
          </span>
        </td>
      </ng-container>

      <!-- Status -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef class="!text-xs !font-medium !text-gray-500 !text-center !pr-6">
          Status
        </th>
        <td mat-cell *matCellDef="let row" class="!text-center !pr-6">
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" [ngClass]="row.isActive
            ? 'bg-green-50 text-green-700 ring-1 ring-green-600/20'
            : 'bg-red-50 text-red-700 ring-1 ring-red-600/20'">
            {{ row.isActive ? 'Active' : 'Inactive' }}
          </span>
        </td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="text-center rounded-tr-xl rounded-br-xl">Actions</th>
        <td mat-cell *matCellDef="let row" class="text-center">
          <div class="flex items-center space-x-1">
            <button mat-icon-button (click)="viewNote(row)" [disabled]="isLoading()"
              class="!w-7 !h-7 text-blue-600 hover:bg-blue-50 transition-colors" matTooltip="View Note">
              <mat-icon class="!text-sm">visibility</mat-icon>
            </button>

            <button mat-icon-button color="warn" (click)="onDelete(row)" [disabled]="isLoading()"
              class="!w-7 !h-7 text-red-600 hover:bg-red-50 transition-colors" matTooltip="Delete Note">
              <mat-icon class="!text-sm">delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <!-- Header and Row Defs -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns" class="!bg-gray-50/50"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"
        class="hover:bg-gray-50/50 transition-colors !border-b !border-gray-100"></tr>
    </table>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading() && dataSource.filteredData.length === 0" class="text-center py-12">
    <div class="flex flex-col items-center">
      <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-4">
        <mat-icon class="text-gray-400 text-xl">note_add</mat-icon>
      </div>
      <h3 class="text-sm font-medium text-gray-900 mb-1">No notes found</h3>
      <p class="text-sm text-gray-500">Get started by creating your first counselor note.</p>
    </div>
  </div>

  <div class="mobile-table-wapper pb-4" >
    <ng-container *ngIf="dataSource.filteredData.length > 0">
    <div class="flex items-center gap-3 mb-4">
        <span>#</span>
        <span class="font-bold">Details</span>
      </div>
    <div class="mobile-view-table" *ngFor = "let element of pagedData;let i = index;">
      <div class="toggle-table flex items-center gap-4">
        <div>
          <span>{{ paginator.pageIndex * paginator.pageSize + i + 1 }}</span>
        </div>
        <div>
          <p class="m-0"><span>{{element.subject}}</span>({{ element.isActive ? 'Active' : 'Inactive' }})</p>
          <p class="m-0">{{element.note}}</p>
        </div>
      </div>
      <div>
        <button mat-icon-button (click)="viewNote(element)" [disabled]="isLoading()"
              class="!w-7 !h-7 text-blue-600 hover:bg-blue-50 transition-colors"
              matTooltip="View Note">
              <mat-icon class="!text-sm">visibility</mat-icon>
            </button>

            <button mat-icon-button color="warn" (click)="onDelete(element)" [disabled]="isLoading()"
              class="!w-7 !h-7 text-red-600 hover:bg-red-50 transition-colors" matTooltip="Delete Note">
              <mat-icon class="!text-sm">delete</mat-icon>
            </button>
      </div>
    </div>
    </ng-container>
</div>

  <!-- Paginator -->
  <div class="main-paginator">
    <div class="paginator-section p-0">
      <mat-paginator #paginator 
        [pageSizeOptions]="[5, 10, 20, 30]" [pageSize]="5" 
        [showFirstLastButtons]="true" [length]="dataSource.filteredData.length || 0"  [disabled]="isLoading()"  class="disabled:opacity-50">
      </mat-paginator>
    </div>
  </div>

</div>
