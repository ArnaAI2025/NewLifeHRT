<app-patient-navigation-bar *ngIf="patientId" [isEditMode]="true" [isSaving]="false" [isActive]="undefined"
  [patientId]="patientId" (close)="onClose()" [activeView]="'sms'" (save)="onSubmit()"
  (addPatient)="onClickAddPatient()" (saveAndClose)="onSaveAndClose()"
  (toggleActiveStatus)="togglePatientActiveStatus($event)">
</app-patient-navigation-bar>

<app-lead-navigation-bar *ngIf="leadId" [leadId]="leadId" [isEditMode]="true" [isSaving]="false" (close)="onClose()"
  [activeView]="'sms'" (save)="onSubmit()" (addLead)="onClickAddLead()" (saveAndClose)="onSaveAndClose()"
  (toggleActiveStatus)="toggleLeadActiveStatus($event)">
</app-lead-navigation-bar>

<header class="bg-gradient-to-r primary-color text-white px-6 py-5 rounded-md header-color">
  <div class="flex items-center justify-between">
    <div class="flex items-center space-x-3">
      <div class="h-10 w-10 rounded-xl bg-white bg-opacity-10 flex items-center justify-center font-semibold">ðŸ’¬</div>
      <div>
        <h1 class="sms-heading">NewLife Rejuvenation â€” SMS</h1>
      </div>
    </div>
  </div>
</header>

<div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between bg-white">
  <div class="flex items-center space-x-3">
    <div class="chat-profile-receiver">
      {{ conversationInformation?.name?.charAt(0)?.toUpperCase() || '?' }}
    </div>
    <div>
      <p class="font-semibold">{{ conversationInformation?.name || 'Unknown' }}</p>
      <p class="text-xs text-gray-500">
        Contact: <span class="font-medium">{{ conversationInformation?.phoneNumber }}</span>
      </p>
    </div>
  </div>
</div>

<main #thread class="main-content-sms">
  <div class="flex items-center justify-center">
    <span class="px-3 py-1 text-xxs uppercase bg-white border border-gray-200 text-gray-500 rounded-full">Today</span>
  </div>

  <ng-container *ngFor="let m of messages()">
    <!-- Patient Messages (Received) -->
    <div *ngIf="m.sender === 'patient'" class="flex items-end space-x-2 max-w-2xl">
      <div class="chat-profile-receiver">
        {{ conversationInformation?.name?.charAt(0)?.toUpperCase() || '?' }}
      </div>
      <div>
        <div class="custom-card">
          <!-- Media contents -->
          <ng-container *ngFor="let media of m.mediaContents">
            <img *ngIf="isImage(media.contentType)" [src]="media.content" alt="Image"
              class="chat-media-img rounded-lg" />
            <video *ngIf="isVideo(media.contentType)" [src]="media.content" controls
              class="chat-media-video rounded-lg"></video>
            <audio *ngIf="isAudio(media.contentType)" [src]="media.content" controls class="mb-2"></audio>
          </ng-container>
          <!-- Text message -->
          <ng-container *ngIf="textContentExists(m)">
            <p class="text-sm" [innerHTML]="m.text"></p>
          </ng-container>
          <!-- Optional list -->
          <ul *ngIf="m.list?.length" class="mt-1 text-sm list-disc list-inside opacity-95">
            <li *ngFor="let item of m.list">{{ item }}</li>
          </ul>
        </div>
        <div class="text-xxs text-gray-400 mt-1">{{ m.time }}</div>
      </div>
    </div>
    <!-- Clinic Messages (Sent) -->
    <div *ngIf="m.sender === 'clinic'" class="flex items-end space-x-2 max-w-2xl ml-auto justify-end">
      <div>
        <div
          class="primary-color text-white rounded-2xl rounded-tr-sm px-4 py-4 shadow-sm max-w-[400px] whitespace-pre-wrap break-words">
          <ng-container *ngIf="m.contentType === 'html'">
            <p [innerHTML]="m.html || m.text"></p>
          </ng-container>
          <ng-container *ngIf="!m.html && m.text">
            <p>{{ m.text }}</p>
          </ng-container>
          <ul *ngIf="m.list?.length" class="mt-1 text-sm list-disc list-inside opacity-95">
            <li *ngFor="let item of m.list">{{ item }}</li>
          </ul>
        </div>
        <div class="text-xxs text-gray-400 mt-1 text-right">{{ m.time }}</div>
      </div>
      <div class="chat-profile-sender">
        {{ m.counselorInitials || 'N' }}
      </div>
    </div>
  </ng-container>

  <!-- Typing Indicator -->
  <div *ngIf="typing" class="flex items-end space-x-2 max-w-2xl ml-auto justify-end">
    <div
      class="bg-indigo-50 text-indigo-700 rounded-2xl rounded-tr-sm px-4 py-4 border border-indigo-200 inline-flex items-center space-x-2">
      <span class="text-sm">Typing</span>
      <span class="flex space-x-1">
        <span class="dot"></span>
        <span class="dot delay-100"></span>
        <span class="dot delay-200"></span>
      </span>
    </div>
  </div>
</main>

<footer class="border-t border-gray-100 p-3 sm:p-4 bg-white" style="position: relative;">
  <form (ngSubmit)="send()" class="space-y-2">
    <div class="flex items-end space-x-2">
      <textarea #draftInput placeholder="Type your messageâ€¦" rows="2" class="text-sm text-area-sms" [(ngModel)]="draft"
        name="draft"></textarea>
      <button type="button" class="text-icons-field" (click)="toggleEmojiPicker()">ðŸ˜Š</button>
      <button type="submit"
        class="px-5 py-2 rounded-lg primary-btn text-white text-sm font-semibold shadow">Send</button>
    </div>
    <emoji-picker *ngIf="emojiPickerOpen" (emoji-click)="addEmoji($event)"
      style="position: absolute; bottom: 58px; left: 40px; z-index: 20;">
    </emoji-picker>
  </form>
</footer>