<section class="brand-card rounded-1xl  overflow-hidden shadow-sm">
    <div class="bg-gradient-to-r primary-color text-white px-6 py-5 rounded-md header-color">
        <h1 class="sms-heading">Bulk Communication Request</h1>
    </div>

    <form class="main-content-bulk-sms" (ngSubmit)="submit()">

        <div class="grid md:grid-cols-3 gap-6">
            <div>
                <label class="custom-label-bulk-sms">Select Entity</label>
                <select class="w-full bulk-form-field" [ngModel]="entity()" name="entity"
                    (ngModelChange)="onEntityChange($event)" [disabled]="isEditMode()">
                    <option value="patient">Patient</option>
                    <option value="lead">Lead</option>
                </select>
            </div>

            <div>
                <span class="custom-label-bulk-sms">Communication Method</span>
                <div class="flex items-center space-x-6">
                    <label class="inline-flex items-center space-x-2">
                        <input type="radio" class="form-radio primary-color-radio" [checked]="method() === 'email'"
                            (change)="method.set('email')" name="methodEmail" [disabled]="isEditMode()" />
                        <span>Email</span>
                    </label>
                    <label class="inline-flex items-center space-x-2">
                        <input type="radio" class="form-radio primary-color-radio" [checked]="method() === 'sms'"
                            (change)="method.set('sms')" name="methodSms" [disabled]="isEditMode()" />
                        <span>SMS</span>
                    </label>
                    <label class="inline-flex items-center space-x-2">
                        <input type="radio" class="form-radio primary-color-radio" [checked]="method() === 'both'"
                            (change)="method.set('both')" name="methodBoth" [disabled]="isEditMode()" />
                        <span>Both</span>
                    </label>
                </div>
            </div>

            <div>
                <span class="custom-label-bulk-sms">Target Audience</span>
                <div class="flex items-center space-x-6">
                    <label class="inline-flex items-center space-x-2">
                        <input type="radio" class="form-radio primary-color-radio" [checked]="audience() === 'all'"
                            (change)="audience.set('all')" name="audienceAll" [disabled]="isEditMode()" />
                        <span>All Patients</span>
                    </label>
                    <label class="inline-flex items-center space-x-2">
                        <input type="radio" class="form-radio primary-color-radio" [checked]="audience() === 'selected'"
                            (change)="audience.set('selected')" name="audienceSelected" [disabled]="isEditMode()" />
                        <span>Selected Patients</span>
                    </label>
                </div>
            </div>
        </div>

        <section *ngIf="audience() === 'selected'">
            <div class="flex items-end justify-between mb-3">
                <h2 class="text-lg font-semibold">Select Patients</h2>
                <div class="text-sm text-gray-500">{{ selectedIds().size }} selected</div>
            </div>

            <div class="grid md:grid-cols-6 gap-3 mb-3">
                <div class="md:col-span-4">
                    <input type="text" placeholder="Search..." [ngModel]="searchTerm()" name="searchTerm"
                        (ngModelChange)="searchTerm.set($event); applyFilters()" class="w-full bulk-form-field"
                        [disabled]="isEditMode()" />
                </div>
                <div class="md:col-span-2">
                    <select #stateSelect [ngModel]="stateFilter()" name="stateFilter"
                        (change)="stateFilter.set(stateSelect.value); applyFilters()" class="w-full bulk-form-field"
                        [disabled]="isEditMode()">
                        <option value="">-- Filter by State --</option>
                        <option *ngFor="let s of states()" [value]="s">{{ s }}</option>
                    </select>
                </div>
            </div>

            <div class="overflow-auto thead-bulk-email thin-scroll">
                <table class="min-w-full text-sm">
                    <thead class="uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3 text-left w-10 ">
                                <input type="checkbox" class="form-checkbox text-blue-600"
                                    [checked]="allVisibleChecked()" (change)="toggleAll($event)"
                                    [disabled]="isEditMode()" />
                            </th>
                            <th class="px-4 py-3 text-left">Name</th>
                            <th class="px-4 py-3 text-left">Email</th>
                            <th class="px-4 py-3 text-left">Phone</th>
                            <th class="px-4 py-3 text-left">State</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr *ngFor="let p of filteredPatients(); trackBy: trackById">
                            <td class="px-4 py-3">
                                <input type="checkbox" class="form-checkbox primary-color-radio"
                                    [checked]="selectedIds().has(p.id)" (change)="toggleRow(p.id, $event)"
                                    [disabled]="isEditMode()" />
                            </td>
                            <td class="px-4 py-3">{{ p.firstName }} {{ p.lastName }}</td>
                            <td class="px-4 py-3">
                                <ng-container *ngIf="p.email; else noemail">{{ p.email }}</ng-container>
                                <ng-template #noemail><span class="text-gray-400 italic">No email</span></ng-template>
                            </td>
                            <td class="px-4 py-3">{{ p.phoneNumber }}</td>
                            <td class="px-4 py-3">{{ p.state }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section>
            <h2 class="sms-heading-comm">Communication Details</h2>

            <div class="grid gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Subject</label>
                    <input type="text" placeholder="Subject" [ngModel]="subject()" (ngModelChange)="subject.set($event)"
                        name="subject" [disabled]="disableField('subject')" class="w-full bulk-form-field" />
                </div>

                <div *ngIf="method() !== 'sms'">
                    <div class="flex items-center justify-between mb-1">
                        <label class="block text-sm font-medium">Email Body</label>
                        <span class="text-xxs text-gray-400">{{ emailPlainLength() }}/4000</span>
                    </div>

                    <div class="bulk-email-field">
                        <button type="button" class="header-button" (click)="exec('undo')" title="Undo">‚Ü∂</button>
                        <button type="button" class="header-button" (click)="exec('redo')" title="Redo">‚Ü∑</button>
                        <span class="sep"></span>

                        <button type="button" class="header-button" (click)="exec('bold')"
                            title="Bold"><b>B</b></button>
                        <button type="button" class="header-button" (click)="exec('italic')"
                            title="Italic"><i>I</i></button>
                        <button type="button" class="header-button" (click)="exec('underline')"
                            title="Underline"><u>U</u></button>

                        <select class="header-button" [ngModel]="emailFont()" name="emailFont"
                            (ngModelChange)="emailFont.set($event)" title="Font" [disabled]="isEditMode()">
                            <option value="">Font</option>
                            <option>Segoe UI</option>
                            <option>Arial</option>
                            <option>Calibri</option>
                            <option>Georgia</option>
                        </select>

                        <button type="button" class="header-button" (click)="highlight()" title="Highlight">A</button>

                        <span class="sep"></span>

                        <button type="button" class="header-button" (click)="exec('insertUnorderedList')"
                            title="Bulleted List">‚Ä¢
                            List</button>
                        <button type="button" class="header-button" (click)="exec('insertOrderedList')"
                            title="Numbered List">1.
                            List</button>

                        <button type="button" class="header-button" (click)="exec('justifyLeft')"
                            title="Align Left">‚ü∏</button>
                        <button type="button" class="header-button" (click)="exec('justifyCenter')"
                            title="Align Center">‚áî</button>
                        <button type="button" class="header-button" (click)="exec('justifyRight')"
                            title="Align Right">‚üπ</button>

                        <button type="button" class="header-button" (click)="insertLink()"
                            title="Insert Link">üîó</button>
                        <button type="button" class="header-button" (click)="insertImage()"
                            title="Insert Image">üñºÔ∏è</button>

                        <button type="button" class="header-button" (click)="exec('removeFormat')"
                            title="Clear Formatting">‚úñ</button>
                        <button type="button" class="header-button" (click)="toggleCode()" [class.active]="codeMode()"
                            title="Code View">&lt;/&gt;</button>
                    </div>

                    <div class="">
                        <div #editorRef class="bulk-email-teaxtarea" [class.hidden]="codeMode()" contenteditable="true"
                            (input)="onEditorInput()" [attr.contenteditable]="!isEditMode()">
                        </div>


                        <textarea #codeRef class="w-full px-3 py-3 bg-white thin-scroll" rows="10"
                            [class.hidden]="!codeMode()" [ngModel]="emailHtml()" (ngModelChange)="emailHtml.set($event)"
                            name="emailHtml" (input)="onCodeInput()" [disabled]="isEditMode()"></textarea>
                    </div>
                </div>

                <div *ngIf="method() !== 'email'">
                    <div class="flex items-center justify-between mb-1">
                        <label class="block text-sm font-medium">SMS Body</label>
                        <span class="text-xxs text-gray-400">{{ sms().length }}/340</span>
                    </div>
                    <textarea rows="4" placeholder="Write your SMS..." maxlength="340" [ngModel]="sms()" name="sms"
                        (ngModelChange)="sms.set($event)" class="w-full bulk-sms-teaxtarea"
                        [disabled]="disableField('sms')"></textarea>
                    <p class="text-xs text-gray-500 mt-1"><span class="brand-chip">340 characters = 1 segment</span></p>
                </div>
            </div>
        </section>

        <div *ngIf="!isEditMode()"
            class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 pt-2 justify-end">
            <button type="button" (click)="reset()"
                class="secondry-button-add brand-btn--outline px-5 py-2.5 rounded-lg font-semibold hover:bg-blue-50"
                [disabled]="isEditMode()">
                Reset Form
            </button>

            <button type="submit" class="primary-btn brand-btn px-5 py-2.5 rounded-lg font-semibold shadow"
                [disabled]="isSubmitting()">
                Submit for Approval
            </button>
        </div>
        <div *ngIf="isEditMode()" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 pt-2 justify-end">
             <button type="button" (click)="reject()"
                class="secondry-button-add brand-btn--outline px-5 py-2.5 rounded-lg font-semibold hover:bg-blue-50">Reject
            </button>

            <button type="button" (click)="approve()"
                class="primary-btn brand-btn--outline px-5 py-2.5 rounded-lg font-semibold hover:bg-blue-50">
                Approve
            </button>           
        </div>
    </form>
</section>