<!-- Responsive Lead Management Table View -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 bg-card-color">
  <!-- Header with Search and Add -->
  <div class="flex items-center justify-between flex-wrap gap-4 mb-6 table-view-header">
    <div class="flex items-center">
      <h2 class="list-page-heading">Leads Management</h2>
      <div class="flex items-center space-x-3 filter-input search-box search-box-dsk">
      <div class="relative ml-6">
        <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
        <input matInput
               type="text"
               [(ngModel)]="searchKeyword"
               (input)="applyFilter()"
               placeholder="Filters by keywords"
               [disabled]="isLoading() || isBulkProcessing()"
               class="pl-10 pr-4 py-2 border border-gray-300 rounded-md w-64 disabled:opacity-50" />
        </div>
      </div>
    </div>

    <div class="flex items-center gap-4 justify-end ml-auto">
     <div *ngIf="selectedCount() > 0"
        class="p-2 bg-blue-50 border border-blue-200 rounded-md flex items-center justify-between">
        <div class="flex items-center">
          <mat-icon class="text-blue-600 mr-2">info</mat-icon>
          <span class="text-blue-800">{{ selectedCount() }} Lead{{ selectedCount() > 1 ? 's' : '' }} selected</span>
        </div>
      </div>
      <button mat-flat-button
              color="primary"
              [disabled]="isLoading() || isBulkProcessing()"
              (click)="onAddLead()"
              class="primary-btn-add">
        <mat-icon class="mr-2">add</mat-icon>
        Add Lead
      </button>

      <!-- Bulk Action Menu -->
      <button type="button" [matMenuTriggerFor]="bulkMenu" [disabled]="selectedCount() < 1" class="secondry-button-add px-2 rounded-md flex items-center gap-1" [ngClass]="{'disabled': selectedCount() < 1}">
       <span class="hidden max-[640px]:hidden sm:inline">Bulk Action</span> <mat-icon>keyboard_arrow_down</mat-icon>
      </button>

<mat-menu #bulkMenu="matMenu">
  <!-- Positive action -->
  <button mat-menu-item (click)="bulkActionAsync('activate')">
      <span class="">Activate</span>
  </button>

  <!-- Negative action -->
  <button mat-menu-item (click)="bulkActionAsync('deactivate')">
      <span>Deactivate</span>
  </button>

  <button mat-menu-item (click)="bulkActionAsync('delete')">
      <span>Delete</span>
  </button>

  <!-- Neutral action -->
  <button mat-menu-item (click)="bulkActionAsync('assign-counsellor')">
    <span>Assign Counselor</span>
  </button>

  <!-- Important conversion action -->
  <button mat-menu-item (click)="onBulkConvertToPatient()">
    <span>Convert To Patient</span>
  </button>

  <!-- Strong negative action -->
  <button mat-menu-item (click)="onBulkDisqualifyLeads()">
    <span>Disqualify Lead</span>
  </button>
</mat-menu>

    </div>
  </div>


  <div class="flex items-center space-x-3 w-full filter-input search-box-mb">
      <!-- Search Input -->
      <div class="relative">
        <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
        <input matInput type="text" placeholder="Filter by keywords" [(ngModel)]="searchKeyword" (input)="applyFilter()"
          [disabled]="isLoading() || isBulkProcessing()"
          class="pl-10 text-left pr-4 py-2 border border-gray-300 rounded-md w-full bg-transparent disabled:bg-transparent disabled:opacity-50 disabled:cursor-not-allowed !bg-transparent" />
      </div>
  </div>

  <!-- Table Section -->
  <div class="overflow-x-auto custom-table-view" [class.opacity-50]="isLoading() || isBulkProcessing()">
    <table mat-table [dataSource]="dataSource" matSort class="custom-table">
      <!-- Select Checkbox -->
      <ng-container matColumnDef="select">
  <!-- Header Checkbox -->
  <th mat-header-cell *matHeaderCellDef class="!text-left !py-3 !px-4 rounded-tl-lg rounded-bl-lg font-medium text-gray-700">
    <mat-checkbox
      class="custom-mat-checkbox"
      (change)="masterToggle()"
      [checked]="isAllSelected()"
      [indeterminate]="selection.hasValue() && !isAllSelected()"
      [disabled]="dataSource.filteredData.length === 0 || isBulkProcessing () || isLoading()">
    </mat-checkbox>
  </th>
  <!-- Row Checkbox -->
  <td mat-cell *matCellDef="let row">
    <mat-checkbox
      class="custom-mat-checkbox"
      (click)="$event.stopPropagation()"
      (change)="toggleRowSelection(row)"
      [checked]="isSelected(row)"
      [disabled]="dataSource.filteredData.length === 0 || isBulkProcessing () || isLoading()">
    </mat-checkbox>
  </td>
</ng-container>


      <!-- Full Name -->
      <ng-container matColumnDef="fullName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Full Name</th>
        <td mat-cell *matCellDef="let row">
          <span class="primary-text-color hover:underline cursor-pointer" (click)="onEdit(row)">{{ row.fullName }}</span>
        </td>
      </ng-container>

      <!-- Email -->
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
        <td mat-cell *matCellDef="let row">{{ row.email }}</td>
      </ng-container>

      <!-- Mobile Number -->
      <ng-container matColumnDef="mobileNumber">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Mobile Number</th>
        <td mat-cell *matCellDef="let row">{{ row.phoneNumber }}</td>
      </ng-container>

      <!-- Topic (Subject) -->
      <ng-container matColumnDef="topic">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Topic</th>
        <td mat-cell *matCellDef="let row">{{ row.subject }}</td>
      </ng-container>

      <!-- Owner -->
      <ng-container matColumnDef="owner">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Owner</th>
        <td mat-cell *matCellDef="let row">{{ row.ownerFullName }}</td>
      </ng-container>
      <ng-container matColumnDef="isQualified">
  <th mat-header-cell *matHeaderCellDef mat-sort-header>Qualified</th>
  <td mat-cell *matCellDef="let row">
    <span
      class="px-2 py-1 rounded-full text-sm font-semibold"
      [ngClass]="
        row.isQualified === true
          ? 'bg-green-100 text-green-800 border border-green-300'
          : row.isQualified === false
            ? 'bg-red-100 text-red-800 border border-red-300'
            : 'bg-gray-100 text-gray-600 border border-gray-300'
      "
    >
      {{
        row.isQualified === true
          ? 'Qualified'
          : row.isQualified === false
            ? 'Not Qualified'
            : 'Not Set'
      }}
    </span>
  </td>
</ng-container>

      <ng-container matColumnDef="status">
  <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
  <td mat-cell *matCellDef="let row">
    <span
      class="px-2 py-1 rounded-full text-sm font-semibold"
      [ngClass]="
        row.isActive === true || row.isActive === 1
          ? 'bg-green-100 text-green-800 border border-green-300'
          : 'bg-gray-100 text-gray-600 border border-gray-300'
      "
    >
      {{ row.isActive === true || row.isActive === 1 ? 'Active' : 'Inactive' }}
    </span>
  </td>
</ng-container>


      <!-- Created Date -->
      <ng-container matColumnDef="createdDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Created Date</th>
        <td mat-cell *matCellDef="let row">{{ row.createdAt | date:'shortDate' }}</td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="text-center rounded-tr-xl rounded-br-xl">Actions</th>
        <td mat-cell *matCellDef="let row">
          <button mat-icon-button [matMenuTriggerFor]="actionMenu" (click)="selectedRow = row">
            <mat-icon>more_vert</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <!-- No Data Message -->
    <div *ngIf="!isLoading() && dataSource.filteredData.length === 0" class="text-center py-8">
      <mat-icon class="text-gray-400 text-4xl mb-2">person_off</mat-icon>
      <p class="text-gray-500">No leads found</p>
    </div>
  </div>

  <!-- mobile view table card -->
  <div class="mobile-table-wapper pb-4" >
    <div class="flex items-center gap-2">
      <mat-checkbox
        class="custom-mat-checkbox"
        (change)="masterToggle()"
        [checked]="isAllSelected()"
        [indeterminate]="selection.hasValue() && !isAllSelected()"
        [disabled]="dataSource.filteredData.length === 0">
      </mat-checkbox>
      <span class="font-bold">Details</span>
    </div>
    <div class="mobile-view-table" *ngFor = "let element of pagedData">
      <div class="toggle-table flex items-center gap-4">
        <div>
          <mat-checkbox
            class="custom-mat-checkbox"
            (click)="$event.stopPropagation()"
            (change)="toggleRowSelection(element)"
            [checked]="isSelected(element)"
            [disabled]="dataSource.filteredData.length === 0">
          </mat-checkbox>
        </div>
        <div>
          <p class="m-0"><span class="user-name" (click)="onEdit(element)">{{element.fullName}}</span>({{element.isActive === true ? 'Active' : 'Inactive' }})</p>
          <p class="m-0">{{element.email}}</p>
          <p class="m-0">{{element.ownerFullName}}</p>
        </div>
      </div>
      <div>
        <button  class="text-gray-400 hover:text-gray-600 disabled:opacity-50" mat-icon-button [matMenuTriggerFor]="actionMenu" (click)="selectedRow = element">
        <mat-icon>more_vert</mat-icon>
        </button>

      </div>
    </div>
  </div>

  <!-- Paginator -->
  <div class="main-paginator">
    <div class="paginator-section p-0">
      <mat-paginator #paginator 
      [pageSizeOptions]="[5, 10, 20, 30]" [pageSize]="5" 
      [showFirstLastButtons]="true" [length]="dataSource.filteredData.length || 0"  [disabled]="isLoading() || isBulkProcessing()"  class="mat-mdc-paginator-container disabled:opacity-50">
    </mat-paginator>
    </div>
  </div>
</div>


<!-- Actions Menu Template -->
<mat-menu #actionMenu="matMenu">

  <!-- Edit action (primary positive) -->
  <button mat-menu-item (click)="onEdit(selectedRow)">
    <span class="">Edit</span>
  </button>
  @if (selectedRow?.isActive){
    <button mat-menu-item (click)="performAction('deactivate',selectedRow)">
      <span>Deactivate</span>
    </button>
  }
  @else {
    <button mat-menu-item (click)="performAction('activate',selectedRow)">
      <span>Activate</span>
    </button>
  }
  <button mat-menu-item (click)="performAction('delete',selectedRow)">
    <span>Delete</span>
  </button>
  <button mat-menu-item (click)="performAction('assign-counsellor',selectedRow)">
                <span>Assign Counselor</span>
  </button>
  <!-- Convert to Patient (positive key action) -->
  <button mat-menu-item (click)="onConvertToPatient(selectedRow)" *ngIf="selectedRow?.isQualified == null">
    <span>Convert To Patient</span>
  </button>

  <!-- Disqualify Lead (negative caution) -->
  <button mat-menu-item (click)="onDisqualifyLead(selectedRow)" *ngIf="selectedRow?.isQualified !== false">
    <span>Disqualify Lead</span>
  </button>

  <!-- Delete (strong negative action, last) -->
</mat-menu>

