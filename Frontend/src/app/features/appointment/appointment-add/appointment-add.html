<app-full-page-loader [visible]="isLoading()" />
<div class="flex flex-wrap gap-2 items-center justify-between rounded-lg px-4 py-2 shadow-sm mb-4 bg-white">

  <div class="flex items-center space-x-2">
    <button mat-icon-button class="header-back-button" (click)="gotoAppointmentView()">
      <mat-icon>chevron_left</mat-icon>
    </button>
    <span class="text-sm font-medium text-gray-700">{{isEditMode() ? "Edit" : "Add"}} Appointment</span>
  </div>

</div>

<div [formGroup]="appointmentForm">
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 bg-card-color">
    <div class="p-5 sm:p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-6 uppercase tracking-wide">Select a Service</h3>
      <div class="mt-4 grid grid-cols-1 gap-3 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4">
        @for (service of clinicAppointmentServices(); track service.id) {
        @let serviceId = appointmentForm.get('clinicService')?.value;
        <label class="group relative rounded-xl p-4 shadow-sm transition border
             {{ serviceId === service.id
                  ? 'border-blue-400 bg-blue-50 cursor-pointer'
                  : isEditMode() && serviceId !== service.id
                    ? 'border-gray-200 bg-gray-100 cursor-not-allowed opacity-60'
                    : 'border-gray-200 bg-white cursor-pointer hover:border-blue-300 hover:shadow' }}">

          <input type="radio" class="service-input hidden" formControlName="clinicService" [value]="service.id"
            [disabled]="isEditMode() && serviceId !== service.id" />

          <div class="flex min-h-20 flex-col justify-between">
            <div class="flex items-start justify-between">
              <p class="text-sm font-semibold text-gray-900">{{ service.displayName }}</p>
              @if(serviceId === service.id){
              <span class="inline-flex items-center gap-1 rounded-md border border-blue-200
                                   bg-white px-2 py-0.5 text-xs font-medium text-blue-700">
                Selected
              </span>
              }
              @if(isEditMode() && serviceId !== service.id){
              <span class="inline-flex items-center gap-1 rounded-md border border-gray-200
                         bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-500">
                Not Available
              </span>
              }
            </div>

            <div class="flex items-center gap-2 text-xs text-gray-500 mt-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1.6">
                <circle cx="12" cy="12" r="9"></circle>
                <path stroke-linecap="round" d="M12 7.5v5l3 1.5" />
              </svg>
              <span>{{ service.maxDuration || 'N/A' }}</span>
            </div>
          </div>
        </label>
        }
      </div>
    </div>
  </div>
  <div class="bg-white rounded-lg shadow-sm border mt-10 border-gray-200 bg-card-color">
    <div class="p-5 sm:p-6">
      <div>
        <h3 class="text-lg font-medium text-gray-900 mb-6 uppercase tracking-wide">Provider Details</h3>
        <div class="space-y-2 custom-text-box">
          <label class="block text-sm font-medium text-gray-700">Select Provider <span
              class="text-red-500">*</span></label>
          <mat-form-field appearance="outline" class="w-full form-input form-input-text">
            <mat-select formControlName="doctorId" placeholder="Select Provider">
              @for(provider of availableProviders(); track provider.userId){
              <mat-option [value]="provider.userId">
                {{ provider.fullName }}
                @if(provider.timezoneAbbreviation){
                ({{ provider.timezoneAbbreviation }})
                }
              </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="border border-gray-200 rounded-xl p-4">
          <p class="text-sm font-medium text-gray-700 mb-3 pb-5">Appointment Date</p>
          <div class="flex justify-center">
            <mat-card class="calendar-card">
              <mat-calendar [selected]="appointmentForm.get('appointmentDate')?.value"
                (selectedChange)="appointmentForm.get('appointmentDate')?.setValue($event)" [minDate]="today"
                [dateFilter]="dateFilter">
              </mat-calendar>
            </mat-card>
          </div>
        </div>

        <div class="border border-gray-200 rounded-xl p-4">
          <p class="text-sm font-medium text-gray-700 mb-3 pb-2">Appointment Time</p>
          @if(isLoadingSlots()){
          <mat-spinner diameter="50"></mat-spinner>
          <div>Loading slots...</div>
          }
          @if(!isLoadingSlots() && appointmentSlots().length === 0){
          <div class="text-center">No slots available</div>
          }
          <div class="time-grid">
            @for (slot of appointmentSlots(); track slot.slotId) {
            <button class="time-btn px-4 py-2 rounded-lg border text-sm focus:outline-none w-full"
              (click)="appointmentForm.get('slotId')?.setValue(slot.slotId)"
              [disabled]="slot.isBooked || slot.isHoliday || slot.isAlreadyPassed" [matTooltip]="
                  slot.isBooked ? 'This slot is already booked'
                  : (slot.isHoliday ? 'This slot is marked as holiday'
                  : (slot.isAlreadyPassed ? 'This slot has already passed' : null))
                " [ngClass]="{
                  'border-blue-400 bg-blue-50 text-blue-700': appointmentForm.get('slotId')?.value === slot.slotId && !(slot.isBooked || slot.isHoliday || slot.isAlreadyPassed ),
                  'border-gray-300 hover:border-blue-400': appointmentForm.get('slotId')?.value !== slot.slotId && !(slot.isBooked || slot.isHoliday || slot.isAlreadyPassed ),
                  'opacity-50 cursor-not-allowed bg-gray-100 text-gray-400 border-gray-200': slot.isBooked || slot.isHoliday || slot.isAlreadyPassed
                }">
              {{ slot.startTime }}
            </button>
            }
          </div>
        </div>
      </div>
      <div>
        <h3 class="text-lg font-medium text-gray-900 mb-6 uppercase tracking-wide">Appointments Details</h3>
        <div class="flex flex-col md:flex-row md:space-x-2 space-y-2 md:space-y-0 w-full">
          <div class="custom-text-box patient-dropdown w-full md:flex-1">
            <label class="block text-sm font-medium text-gray-700 pb-2">
              Select Patients <span class="text-red-500">*</span>
            </label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <mat-select formControlName="patientId" placeholder="Select Patient">
                @for(patient of patients(); track patient.id){
                <mat-option [value]="patient.id">
                  {{ patient.value }}
                </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <div class="mode-types w-full md:flex-1 flex py-2">
            <mat-button-toggle-group formControlName="mode" [hideSingleSelectionIndicator]="true"
              class="toggle-group w-full">
              @for(mode of appointmentModes(); track mode.id){
              <mat-button-toggle [value]="mode.id" class="nav-header-tabs w-full md:w-auto" [ngClass]="{
                    'active': appointmentForm.get('mode')?.value === mode.id,
                    'inactive': appointmentForm.get('mode')?.value !== mode.id
                  }">
                {{ mode.modeName }}
              </mat-button-toggle>
              }
            </mat-button-toggle-group>
          </div>
        </div>
        <div class="space-y-2 custom-text-box">
          <label class="block text-sm font-medium text-gray-700">Appointment Notes (Optional)</label>
          <mat-form-field appearance="outline" class="w-full form-des-input">
            <textarea matInput formControlName="description" placeholder="Add Notes Or Requests"></textarea>
          </mat-form-field>
        </div>
        <div class="flex justify-end space-x-2 p-6 pt-0 mt-4">
          <button type="button" mat-flat-button class="primary-btn-add"
            [ngClass]="{'disabled': appointmentForm.invalid}" (click)="onConfirmAppointment()"
            [disabled]="appointmentForm.invalid || isLoading() || isLoadingSlots()">
            Confirm Appointment
          </button>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Form -->
