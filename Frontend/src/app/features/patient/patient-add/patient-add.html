<!-- Navigation Bar -->
 <app-full-page-loader [visible]="isLoadingPage()" />
<app-patient-navigation-bar [isEditMode]="isEditMode" [isSaving]="isSaving()" [isActive]="patientDataToLoad?.isActive"
  [patientId]="patientId" (close)="onClose()" (save)="onSubmit()" (addPatient)="onClickAddPatient()"
  (saveAndClose)="onSaveAndClose()" (toggleActiveStatus)="togglePatientActiveStatus($event)" (delete)="onPatientDelete()">
</app-patient-navigation-bar>

<div>
  <div class="card-color p-6 rounded-lg shadow border border-gray-200">
    <form [formGroup]="patientForm" (ngSubmit)="onSubmit()">
      <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-3 gap-6 items-start">
        <!-- Profile Picture Upload -->
        <div class="col-span-1 flex flex-col items-center profile-container">
<div
  class="profile-pic rounded-xl bg-gray-100 flex items-center justify-center overflow-hidden mb-4 text-5xl font-semibold text-blue-600 uppercase">

  <ng-container *ngIf="patientForm.get('profileUrl')?.value; else placeholder">
    <img
      [src]="patientForm.get('profileUrl')?.value"
      alt="Profile"
      class="object-cover w-full h-full" />
  </ng-container>

  <ng-template #placeholder>
    <div
      class="rounded-xl bg-gray-100 text-blue-500 font-semibold text-[2rem] flex items-center justify-center">
      {{ getInitials() }}
    </div>
  </ng-template>
</div>


          <button *ngIf = "!isPatientLoggedIn"
  mat-flat-button
  color="primary"
  class="patient-upload-btn flex"
  type="button"
  (click)="fileInput.click()">
  Upload Image
</button>

<input
  type="file"
  #fileInput
  (change)="onUploadImage($event)"
  accept="image/*"
  style="display: none;" />

        </div>

        <!-- Form Fields -->
        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- First Name -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">First Name <span
                class="text-red-500">*</span></label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput formControlName="firstName" placeholder="First Name" />
              <mat-error *ngIf="isFieldInvalid('firstName')">{{ getFieldError('firstName') }}</mat-error>
            </mat-form-field>
          </div>

          <!-- Last Name -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Last Name <span class="text-red-500">*</span></label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput formControlName="lastName" placeholder="Last Name" />
              <mat-error *ngIf="isFieldInvalid('lastName')">{{ getFieldError('lastName') }}</mat-error>
            </mat-form-field>
          </div>

          <!-- Gender -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Gender <span class="text-red-500">*</span></label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <mat-select formControlName="gender" placeholder="Select">
                <mat-option *ngFor="let option of genderOptions" [value]="option.value">
                  {{ option.label }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="isFieldInvalid('gender')">{{ getFieldError('gender') }}</mat-error>
            </mat-form-field>
          </div>

          <!-- Date of Birth -->
          <div class="space-y-2 custom-text-box">
  <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
  <mat-form-field appearance="outline" class="w-full form-input form-input-text">
    <input
      matInput
      [matDatepicker]="picker"
      [max]="maxDate"
      formControlName="dateOfBirth"
      placeholder="Date of birth"
      readonly
      (click)="picker.open()"
    />
    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
  </mat-form-field>
</div>


          <!-- Patient Number -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Patient Number </label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput formControlName="patientNumber" placeholder="07386" />
              <mat-error *ngIf="isFieldInvalid('patientNumber')">{{ getFieldError('patientNumber') }}</mat-error>
            </mat-form-field>
          </div>

          <!-- Driving Licence -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Driving Licence</label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput formControlName="drivingLicence" placeholder="DL Number" />
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Contact Information Section -->
      <div class="mt-4 rounded-md">
        <h3 class="text-lg font-medium text-gray-900 mt-10 mb-6 uppercase tracking-wide">Contact Information</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-4">
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Phone</label>
                        <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput type="tel" formControlName="phoneNumber" placeholder="+1 (123) 456-7890" maxlength="12"
                class="text-sm" />
              <mat-error *ngIf="isFieldInvalid('phoneNumber')">
                {{ getFieldError('phoneNumber') }}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Email -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Email <span class="text-red-500">*</span></label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput type="email" formControlName="email" placeholder="abc@xyz.com" class="text-sm" />
              <mat-error *ngIf="isFieldInvalid('email')">{{ getFieldError('email') }}</mat-error>
            </mat-form-field>
          </div>

          <!-- Address Line 1 -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Street</label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput formControlName="addressLine1" placeholder="123 Main Street" class="text-sm" />
            </mat-form-field>
          </div>

          <!-- City -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">City</label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput formControlName="city" placeholder="City Name" class="text-sm" />
            </mat-form-field>
          </div>
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Country<span class="text-red-500">*</span></label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input type="text" matInput placeholder="Country" formControlName="countryId" [matAutocomplete]="auto"
                autocomplete="off" (input)="onCountryInput($any($event.target).value)" />
              <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onCountrySelected($event.option.value)"
                [displayWith]="displayCountryName">
                <mat-option *ngFor="let country of filteredcountriesList" [value]="country.id">
                  {{ country.value }}
                </mat-option>
              </mat-autocomplete>
              <mat-error *ngIf="isFieldInvalid('countryId')">
                {{ getFieldError('countryId') }}
              </mat-error>
            </mat-form-field>
          </div>
          
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">
              State<span class="text-red-500">*</span>
            </label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <mat-select formControlName="stateId" placeholder="Select State" [disabled]="allStates.length === 0">
                <mat-option *ngFor="let state of allStates" [value]="state.id">
                  {{ state.value }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="isFieldInvalid('stateId')">
                {{ getFieldError('stateId') }}
              </mat-error>
            </mat-form-field>
          </div>
      
          <!-- Postal Code -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Postal Code <span class="text-red-500">*</span></label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput formControlName="postalCode" placeholder="123456"
                class="text-sm" (keypress)="allowOnlyNumbers($event)" (paste)="validatePaste($event)" maxlength="6"/>
              <mat-error *ngIf="isFieldInvalid('postalCode')">{{ getFieldError('postalCode') }}</mat-error>
            </mat-form-field>
          </div>
        </div>

      </div>
      <!-- Attachments Section -->
      <div class="mt-4 bg-gray-50 rounded">
        <div class="attachments-heading-line mb-4">
          <h3 class="attachments-heading text-lg font-medium text-gray-900 mt-10 mb-6 uppercase tracking-wide">
            Attachments</h3>
          <!-- Action Icons -->
          <div class="flex gap-3" *ngIf = "!isPatientLoggedIn">
            <button type="button" (click)="onClickDownloadDocument()" mat-icon-button><mat-icon>file_download</mat-icon></button>
            <button type="button" (click)="onClickDeleteDocument()" mat-icon-button><mat-icon>delete</mat-icon></button>

          </div>
        </div>

        <!-- Table Header -->
<!-- Table Header -->
<div class="grid grid-cols-5 gap-2 px-3 py-2 bg-gray-100 rounded-t patient-attachments-table">
  <div class="form-checkbox custom-mat-checkbox">
    <input
      type="checkbox"
      [checked]="isAllSelected"
      [indeterminate]="isIndeterminate"
      (change)="toggleSelectAll()"
      [disabled]="uploadedFiles().length == 0"
    />
  </div>
  <div class="col-span-1 font-medium">File Name</div>
  <div class="col-span-1 font-medium">Category Name</div>
  <div class="col-span-1 font-medium">Date Added</div>
  <!-- <div class="col-span-1 font-medium">Action</div> -->
</div>

<!-- Table Rows -->
<div *ngFor="let file of uploadedFiles();"
     class="grid grid-cols-5 gap-2 px-3 py-2 border-t border-l border-r border-gray-200">

  <div>
    <input
      type="checkbox"
      class="form-checkbox"
      [checked]="isFileSelected(file)"
      (change)="toggleFileSelection(file, $event)"
    >
  </div>
  <div class="truncate">{{ file.attachmentName }}</div>
  <div>{{ file.categoryName }}</div>
  <div>{{ file.createdAt | date }}</div>
  <!-- <div>
    <button type="button"
            (click)="openFileModal(file)"
            class="px-3 py-1 text-sm text-white bg-blue-500 rounded hover:bg-blue-600">
      View
    </button>
  </div> -->
</div>

        <!-- No Files Row -->
        <div *ngIf="uploadedFiles().length === 0" class="px-3 py-6 text-gray-500 flex items-center justify-center uploaded-card">
          <mat-icon class="mr-2">folder_open</mat-icon>
          No files uploaded yet.
        </div>

        <!-- Files List -->



        <!-- Dropzone Area -->
        <!-- <div class="mt-4 p-4 border-2 rounded-lg border-dashed border-gray-300 rounded flex flex-col items-center">
          <div class="flex items-center gap-2 text-gray-600">
            <mat-icon>cloud_upload</mat-icon>
            <span>Drag and drop files here or</span>
            <button type="button" class="text-blue-600 underline" (click)="fileInput.click()">Browse</button>
            <input #fileInput type="file" class="hidden" (change)="onFileSelected($event)" multiple
              accept=".pdf,.doc,.jpg,.png">
          </div>
          <div class="text-sm text-gray-500 mt-2">Accepted formats: PDF, DOC, JPG, PNG</div>
        </div> -->
      </div>
             <div class="w-full flex justify-end" *ngIf = "!isPatientLoggedIn">
         <button type="button" mat-raised-button color="primary" class="mt-4 "
          (click)="openSelectCategoryDialog()">Upload Files</button>
       </div>

       <div class="mt-4 bg-gray-50 rounded">
  <h3 class="text-lg font-medium text-gray-900 mt-10 mb-6 uppercase tracking-wide">Financial</h3>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-4">
    <!-- Outstanding Refund Balance -->
    <div class="space-y-2 custom-text-box">
      <label class="block text-sm font-medium text-gray-700">Outstanding Refund Balance</label>
      <mat-form-field appearance="outline" class="w-full form-input form-input-text">
        <input
          matInput
          formControlName="outstandingRefundBalance"
          placeholder="0.00"
          type="number"
        />
      </mat-form-field>
    </div>
  </div>
</div>

      <!-- Visit & Medical Details Section -->
      <div class="mt-8 rounded-md">
        <h3 class="text-lg font-medium text-gray-900 mt-10 mb-6 uppercase tracking-wide">Visit & Medical Details</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
          <!-- Visit Type -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Visit Type</label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <mat-select formControlName="visitTypeId" placeholder="---" [disabled]="isLoadingVisitType">
                <mat-option value="">---</mat-option>
                <mat-option *ngFor="let visitType of visitTypeList" [value]="visitType.id">
                  {{ visitType.value }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="isLoadingVisitType">Loading visit types...</mat-hint>
            </mat-form-field>
          </div>

          <!-- Assign Physician -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Assign Doctor</label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input type="text" matInput placeholder="Select Doctor" [matAutocomplete]="physicianAuto"
                formControlName="assignPhysicianId" [disabled]="isLoadingDoctor" />
              <mat-autocomplete #physicianAuto="matAutocomplete" [displayWith]="displayPhysician"
                (optionSelected)="onPhysicianSelected($event.option.value)">
                <mat-option *ngFor="let doctor of filteredDoctorsList" [value]="doctor">
                  {{ doctor.value }}
                </mat-option>
              </mat-autocomplete>
              <mat-hint *ngIf="isLoadingDoctor">Loading Doctors...</mat-hint>
            </mat-form-field>
          </div>

          <!-- Counselor -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">
              Sales Person<span class="text-red-500">*</span>
            </label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input type="text" matInput placeholder="Select Sales Person" [matAutocomplete]="counselorAuto"
                formControlName="counselorId" [disabled]="isLoadingSales" />
              <mat-autocomplete #counselorAuto="matAutocomplete" [displayWith]="displayCounselor"
                (optionSelected)="onCounselorSelected($event.option.value)">
                <mat-option *ngFor="let counselor of filteredSalesPersonList" [value]="counselor">
                  {{ counselor.value }}
                </mat-option>
              </mat-autocomplete>
              <mat-error *ngIf="isFieldInvalid('counselorId')">
                {{ getFieldError('counselorId') }}
              </mat-error>
              <mat-hint *ngIf="isLoadingSales">Loading Sales Person...</mat-hint>
            </mat-form-field>
          </div>


          <!-- Previous Counselor -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Previous Sales Person</label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput formControlName="previousCounselorFullName" placeholder="Previous Sales Person" />
            </mat-form-field>
          </div>


          <!-- Referral -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Referral</label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <mat-select formControlName="referralId" placeholder="Select Referral" [disabled]="isLoadingPatient">
                <mat-option *ngFor="let referralItem of patientList" [value]="referralItem.id">
                  {{ referralItem.value }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="isLoadingPatient">Loading referrals...</mat-hint>
            </mat-form-field>
          </div>


          <!-- Allergies -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Allergies <span class="text-red-500">*</span></label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput formControlName="allergies" placeholder="Enter allergies or type 'None'" />
              <mat-error *ngIf="isFieldInvalid('allergies')">{{ getFieldError('allergies') }}</mat-error>
            </mat-form-field>
          </div>

          <!-- Patient's Agenda -->
          <!-- Patient's Agenda - Multi-Select -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Patient's Agenda</label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <mat-select formControlName="agendaId" placeholder="Select Agendas" [disabled]="isLoadingAgenda" multiple>
                <mat-option *ngFor="let agendaItem of agendaList" [value]="agendaItem.id" class="custom-mat-checkbox">
                  {{ agendaItem.value }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="isLoadingAgenda">Loading agendas...</mat-hint>
            </mat-form-field>
          </div>


          <!-- Patient's Goal -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700">Patient's Goal</label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput formControlName="patientGoal" placeholder="Goal" />
            </mat-form-field>
          </div>
        </div>
      </div>



      <!-- Administrative Settings -->
      <div class="card-color rounded-lg mt-2">
        <h3 class="text-lg font-medium text-gray-900 mt-10 mb-6 uppercase tracking-wide">Administrative / Settings</h3>

        <!-- First Row: Split Commission & Status -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
          <!-- Split Commission -->
          <div class="flex items-center h-full">
            <mat-checkbox formControlName="splitCommission" class="custom-mat-checkbox">Split Commission</mat-checkbox>
          </div>

          <!-- Status -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <mat-select formControlName="status" placeholder="---">
                <mat-option [value]="true">Active</mat-option>
                <mat-option [value]="false">Inactive</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      </div>
    </form>
  </div>
  <!-- Communication Preferences + Credit Card Section -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4 mb-4">
    <!-- Communication Preferences -->
    <div class="card-color rounded-lg shadow p-6 space-y-4 border border-gray-200" [formGroup]="patientForm">
      <h3 class="flex items-center text-base font-semibold text-gray-700 mb-3">
        <mat-icon color="primary" class="mr-2 credit-card-checkbox">mail</mat-icon> Communication Preferences
      </h3>
      <div class="space-y-2 custom-text-box">
        <label class="block text-sm font-medium text-gray-700 mb-1">Email Notifications</label>
        <mat-form-field appearance="outline" class="w-full form-input form-input-text">
          <mat-select formControlName="isAllowMail" placeholder="Select">
            <mat-option [value]="true">Allow</mat-option>
            <mat-option [value]="false">Deny</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="space-y-2 custom-text-box">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Lab Renewal Alert Date
          </label>
          <mat-form-field appearance="outline" class="w-full form-input form-input-text">
            <input
              matInput
              [matDatepicker]="labRenewalAlertPicker"
              formControlName="labRenewableAlertDate"
              placeholder="YYYY-MM-DD"
              readonly
              (click)="labRenewalAlertPicker.open()"
            />
            <mat-datepicker-toggle matSuffix [for]="labRenewalAlertPicker"></mat-datepicker-toggle>
            <mat-datepicker #labRenewalAlertPicker></mat-datepicker>
          </mat-form-field>
      </div>
      <!-- <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Lab Renewal Date</label>
          <mat-form-field appearance="outline" class="w-full">
            <input matInput formControlName="labRenewalDate" [matDatepicker]="labRenewalDatePicker" placeholder="Select Date"/>
            <mat-datepicker-toggle matSuffix [for]="labRenewalDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #labRenewalDatePicker></mat-datepicker>
          </mat-form-field>
        </div> -->
    </div>

    <!-- Add Credit Card -->
    <div class="card-color rounded-lg shadow p-6 space-y-4 border border-gray-200">
      <div class="flex flex-wrap gap-2 justify-between items-center mb-4" *ngIf = "!isPatientLoggedIn">
        <h3 class="add-credit-card text-base font-semibold text-gray-800 flex items-center">
          <mat-icon class="mr-2 text-blue-600 credit-card-checkbox">credit_card</mat-icon>
          {{ isEditingCreditCard ? 'Edit Credit Card' : 'Add Credit Card' }}
        </h3>

        <button type="button" mat-raised-button color="primary" class="!normal-case px-4"
          (click)="openCreditCardModal()">
          + New Credit Card
        </button>
      </div>

      <ng-container *ngFor="let card of savedCards; let i = index">
        <div class="border flex items-center justify-between p-3 mb-2 rounded bg-gray-50">
          <div>
            <div class="flex items-center gap-2">
              <mat-icon color="primary">credit_card</mat-icon>
              <span>•••• {{ card.last4 }}</span>
            </div>
            <p class="text-sm text-gray-600 mt-1">
              Expiry: {{ card.expiryMonth }}/{{ card.expiryYear }}
              <span class="ml-2 text-gray-500">• {{ CardTypeEnum[card.cardType] | titlecase }}</span>
            </p>
          </div>

          <button type="button" mat-icon-button [matMenuTriggerFor]="cardMenu">
            <mat-icon>more_vert</mat-icon>
          </button>

          <mat-menu #cardMenu="matMenu">
            <button mat-menu-item (click)="editCreditCard(i)" class="text-blue-600">
              <mat-icon>edit</mat-icon>
              <span>Edit Card</span>
            </button>
            <button mat-menu-item (click)="removeCreditCard(i)" class="text-red-600">
              <mat-icon>delete</mat-icon>
              <span>Remove Card</span>
            </button>
          </mat-menu>
        </div>
      </ng-container>

      <!-- No Cards Message -->
      <div *ngIf="savedCards.length === 0" class="text-center text-gray-500 py-4">
        <mat-icon class="text-gray-400 mb-2">credit_card_off</mat-icon>
        <p>No credit cards added yet</p>
      </div>
    </div>

  </div>
  <!-- Existing patient form content... -->

  <!-- Credit Card Modal Overlay -->
  <div *ngIf="showCreditCardModal"
    class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
    (click)="closeCreditCardModal()">
    <!-- Modal Content -->
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-screen overflow-y-auto"
      (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-6 border-b border-gray-200">
        <h2 class="attachments-heading text-xl font-semibold text-gray-800 flex items-center">
          <mat-icon class="credit-card-checkbox mr-2 text-blue-600">credit_card</mat-icon>
          Add Credit Card
        </h2>
        <button type="button" mat-icon-button (click)="closeCreditCardModal()"
          class="text-gray-500 hover:text-gray-700">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="p-6 border-b border-gray-200">
        <!-- Conditional validation message -->
        <div *ngIf="hasCreditCardData() && creditCardForm.invalid"
          class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
          <p class="text-sm text-yellow-800">
            <mat-icon class="text-yellow-600 mr-1" style="font-size: 16px;">info</mat-icon>
            Please fill in all credit card fields or leave them all empty.
          </p>
        </div>

        <form [formGroup]="creditCardForm" class="space-y-4">
          <!-- Credit Card Number -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Credit Card Number <span class="text-red-500" *ngIf="hasCreditCardData()">*</span>
            </label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <input matInput formControlName="creditCardNumber" placeholder="1234 5678 9012 3456" maxlength="19"
                (input)="onCardNumberInput($event)" />
              <mat-icon matSuffix class="credit-card-checkbox text-gray-400">credit_card</mat-icon>
              <mat-error *ngIf="isCreditCardFieldInvalid('creditCardNumber')">
                {{ getCreditCardFieldError('creditCardNumber') }}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Card Type -->
          <div class="space-y-2 custom-text-box">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Card Type <span class="text-red-500" *ngIf="hasCreditCardData()">*</span>
            </label>
            <mat-form-field appearance="outline" class="w-full form-input form-input-text">
              <mat-select formControlName="cardType" placeholder="Select card type">
                <mat-option value="">---</mat-option>
                <mat-option *ngFor="let type of cardEnumValues" [value]="type">
                  {{ getCardTypeFullName(type) }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="isCreditCardFieldInvalid('cardType')">
                {{ getCreditCardFieldError('cardType') }}
              </mat-error>
            </mat-form-field>


          </div>

          <!-- Expiry Date Row -->
          <div class="grid grid-cols-2 gap-4">
            <!-- Month -->
            <div class="space-y-2 custom-text-box">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Month <span class="text-red-500" *ngIf="hasCreditCardData()">*</span>
              </label>
              <mat-form-field appearance="outline" class="w-full form-input form-input-text">
                <mat-select formControlName="expiryMonth" placeholder="Month">
                  <mat-option value="">---</mat-option>
                  <mat-option *ngFor="let type of monthEnumValues" [value]="type">
                    {{ MonthEnum[type] }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="isCreditCardFieldInvalid('expiryMonth')">
                  {{ getCreditCardFieldError('expiryMonth') }}
                </mat-error>
              </mat-form-field>


            </div>

            <!-- Year -->
            <div class="space-y-2 custom-text-box">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Year <span class="text-red-500" *ngIf="hasCreditCardData()">*</span>
              </label>
              <mat-form-field appearance="outline" class="w-full form-input form-input-text">
                <mat-select formControlName="expiryYear" placeholder="Year">
                  <mat-option value="">---</mat-option>
                  <mat-option *ngFor="let year of years" [value]="year.value">
                    {{ year.label }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="isCreditCardFieldInvalid('expiryYear')">
                  {{ getCreditCardFieldError('expiryYear') }}
                </mat-error>
              </mat-form-field>
            </div>
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div class="flex justify-end space-x-2 p-6 pt-0 mt-4">
        <button type="button" *ngIf = "hasCreditCardData()" mat-button (click)="closeCreditCardModal()" class="text-gray-600 secondry-button-add">
          Cancel
        </button>
        <button type="button" mat-raised-button color="primary" class="primary-btn-add" (click)="onSaveCreditCard()"
          [disabled]="hasCreditCardData() && creditCardForm.invalid">
          {{ hasCreditCardData() ? 'Save Credit Card' : 'Close' }}
        </button>
      </div>
    </div>
  </div>

</div>
<div *ngIf="activeView === 'counselor' && patientId" class="counselor-container">
</div>

<!-- Step 1: Select Category -->
<div *ngIf="isOpenSelectCategoryDialog()" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
  <div class="w-full max-w-lg p-6 bg-white rounded-lg shadow-lg">
    <h2 class="text-xl font-semibold mb-6">Select The Category</h2>
    <div class="grid grid-cols-3 gap-4 mb-6  category-button">
      <button *ngFor="let cat of documentCategories"
        (click)="selectCategory(cat)"
        type="button"
        class="flex flex-col items-center p-4 border rounded-lg transition"
        [ngClass]="{
          'Category-button-active': selectedCategory?.id === cat.id,
          'Category-button-inactive': selectedCategory?.id !== cat.id
        }">
        <mat-icon class="mb-2 text-gray-500">description</mat-icon>
        <span [ngClass]="{
          'Category-text-active': selectedCategory?.id === cat.id,
        }">{{cat.value}}</span>
      </button>
    </div>
    <div class="flex justify-end space-x-4">
      <button mat-stroked-button (click)="cancel()" class="secondry-button-add">Cancel</button>
      <button mat-flat-button class="primary-btn" [disabled]="!selectedCategory" (click)="proceed()">Proceed</button>
    </div>
  </div>
</div>

<!-- Step 2: Upload Document -->
<div *ngIf="openUploadDialog()" class="fixed inset-0 z-10 flex items-center justify-center bg-black bg-opacity-50">
  <div class="w-full max-w-lg p-6 bg-white rounded-lg shadow-lg">
    <h2 class="text-xl font-semibold mb-4">Upload Document</h2>
    <div class="border border-dashed rounded-lg p-4 mb-4 flex flex-col items-center">
      <mat-icon class="text-4xl text-gray-400">cloud_upload</mat-icon>
      <input type="file" multiple (change)="onFileChange($event)" class="mt-2" />
    </div>

    <!-- Show all files for this category -->
    <div *ngIf="files.length > 0" class="mb-4 space-y-2 uploaded-files-list">
      <div *ngFor="let f of files; let i = index" class="flex items-center justify-between border-b pb-1">
        <span class="text-sm truncate whitespace-normal">
          {{ f.file.name }}
          <small class="text-gray-500">({{ f.fileCategory }})</small>
        </span>
        <button mat-icon-button color="warn" (click)="removeFile(i)">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <div class="flex justify-end space-x-4">
      <button mat-stroked-button (click)="cancel()">Cancel</button>
      <button mat-flat-button class="primary-btn" [disabled]="files.length === 0"(click)="save('close')">{{ isEditMode ? 'Save & Close' : 'Add & Close' }}</button>
      <button mat-stroked-button  [disabled]="files.length === 0" (click)="save('addMore')">{{ isEditMode ? 'Save & Add More' : 'Add & Add More' }}</button>
 </div>
  </div>
</div>

<!-- component.html -->
<!-- File Preview Modal -->
<div *ngIf="isFileModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-4 rounded-lg w-3/4 h-3/4 relative shadow-xl">

    <!-- Top Right Buttons -->
    <div class="absolute top-2 right-2 flex space-x-2">
      <!-- Download Button -->
      <a *ngIf="selectedFileUrl"
         [href]="selectedFileUrl"
         [attr.download]="getDownloadFileName()"
         target="_blank"
         class="text-gray-600 hover:text-blue-600 p-1 rounded-full border border-gray-300 hover:border-blue-500"
         matTooltip="Download File">
        <mat-icon>download</mat-icon>
      </a>

      <!-- Close Button -->
      <button type="button"
              (click)="closeFileModal()"
              class="text-gray-600 hover:text-black p-1 rounded-full border border-gray-300 hover:border-black"
              matTooltip="Close">
        ✕
      </button>
    </div>

    <!-- Loading Spinner -->
    <div *ngIf="isFileLoading" class="flex items-center justify-center h-full">
      <mat-spinner diameter="50"></mat-spinner>
    </div>

    <!-- File Content -->
    <ng-container *ngIf="!isFileLoading">
      <!-- Image -->
      <img *ngIf="selectedFileType === 'image'"
           [src]="selectedFileUrl"
           class="w-full h-full object-contain" />

      <!-- PDF -->
      <iframe *ngIf="selectedFileType === 'pdf'"
              [src]="selectedFileUrl"
              class="w-full h-full border-0"></iframe>

      <!-- Office Docs -->
      <!-- <iframe *ngIf="selectedFileType === 'office'"
              [src]="'https://view.officeapps.live.com/op/embed.aspx?src=' + encodeURIComponent(selectedFileUrl)"
              class="w-full h-full border-0"></iframe> -->

      <!-- Other Files -->
      <div *ngIf="selectedFileType === 'other'"
           class="flex flex-col items-center justify-center h-full">
        <p class="mb-4">Preview not available for this file type.</p>
        <a [href]="selectedFileUrl"
           target="_blank"
           class="text-blue-500 underline">Download file</a>
      </div>
    </ng-container>

  </div>
</div>


