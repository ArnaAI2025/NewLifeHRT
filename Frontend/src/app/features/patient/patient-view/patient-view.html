<div class="card-color rounded-lg shadow-sm flex-wrap gap-4 mb-6 table-view-header border border-gray-200 p-6">
  <!-- Header -->
  <div class="flex items-center flex-wrap gap-4 justify-between mb-6 table-view-header">
    <div class="flex items-center">
      <h1 class="list-page-heading">Patients</h1>
      <div class="flex items-center space-x-3 filter-input search-box search-box-dsk">
        <!-- Search Input -->
        <div class="relative ml-6">
          <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
          <input matInput type="text" placeholder="Filter by keywords" [(ngModel)]="searchKeyword"
            (input)="applyFilter()" [disabled]="isLoading()"
            class="pl-10 text-left pr-4 py-2 border border-gray-300 rounded-md  w-64 disabled:bg-gray-100 disabled:cursor-not-allowed"/>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-4 justify-end ml-auto">
       <div *ngIf="getSelectedCount() > 0"
        class="p-2 bg-blue-50 border border-blue-200 rounded-md flex items-center justify-between">
        <div class="flex items-center">
          <mat-icon class="text-blue-600 mr-2">info</mat-icon>
          <span class="text-blue-800">{{ getSelectedCount() }} Patient{{ getSelectedCount() > 1 ? 's' : '' }} selected</span>
        </div>
      </div>
      <button mat-flat-button (click)="showForm( null)" [disabled]="isLoading()"
        class="flex items-center text-blue-600 primary-btn-add">
        <mat-icon class="mr-1">add</mat-icon>
        Add Patient
      </button>
      <!-- <button mat-button  [disabled]="false" class="border border-gray-300 rounded-md px-4 py-2 flex items-center">
        Bulk Action <mat-icon class="ml-2">arrow_drop_down</mat-icon>
      </button> -->
      <button type="button" [matMenuTriggerFor]="bulkMenu" [disabled]="getSelectedCount() < 1" class="secondry-button-add px-2 rounded-md flex items-center gap-1" [ngClass]="{'disabled': getSelectedCount() < 1}">
       <span class="hidden max-[640px]:hidden sm:inline">Bulk Action</span> <mat-icon>keyboard_arrow_down</mat-icon>
      </button>
      <mat-menu #bulkMenu="matMenu">
        <button mat-menu-item (click)="performAction('activate',null,true)">
          <span>Activate</span>
        </button>
        <button mat-menu-item (click)="performAction('deactivate',null,true)">
          <span>Deactivate</span>
        </button>
        <button mat-menu-item (click)="performAction('delete',null,true)">
          <span>Delete</span>
        </button>
        <button mat-menu-item (click)="performAction('assign-counsellor',null,true)">
          <span>Assign Counselor</span>
        </button>
      </mat-menu>
    </div>
    <div class="flex items-center space-x-3 w-full filter-input search-box-mb">
      <!-- Search Input -->
      <div class="relative">
        <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
        <input matInput type="text" placeholder="Filter by keywords" [(ngModel)]="searchKeyword" (input)="applyFilter()"
          [disabled]="isLoading()"
          class="pl-10 text-left pr-4 py-2 border border-gray-300 rounded-md w-full bg-transparent disabled:bg-transparent disabled:opacity-50 disabled:cursor-not-allowed !bg-transparent" />

      </div>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  <!-- <div *ngIf="getSelectedCount() > 0" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md flex items-center justify-between">
    <div class="flex items-center">
      <mat-icon class="text-blue-600 mr-2">info</mat-icon>
      <span class="text-blue-800">{{ getSelectedCount() }} patient(s) selected</span>
    </div>
    <div class="flex items-center space-x-2">
      <button mat-button (click)="clearSelection()" [disabled]="isBulkDeleting()">
        Clear Selection
      </button>
      <button mat-raised-button color="warn" (click)="onBulkToggleActive(true)" [disabled]="isBulkDeleting()"
        class="flex items-center">
        <mat-spinner *ngIf="isBulkDeleting()" diameter="16" class="mr-2"></mat-spinner>
        <mat-icon *ngIf="!isBulkDeleting()" class="mr-1">delete</mat-icon>
        {{ isBulkDeleting() ? 'Deleting...' : 'Deactivate Selected' }}
      </button>
      <button mat-raised-button color="primary" (click)="onBulkToggleActive(false)" [disabled]="isBulkDeleting()"
        class="flex items-center">
        <mat-spinner *ngIf="isBulkDeleting()" diameter="16" class="mr-2"></mat-spinner>
        <mat-icon *ngIf="!isBulkDeleting()" class="mr-1">check_circle</mat-icon>
        {{ isBulkDeleting() ? 'Activating...' : 'Activate Selected' }}
      </button>

    </div>
  </div> -->

  <!-- Loading Spinner -->
  <div *ngIf="isLoading()"
    class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 rounded-lg">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto custom-table-view" [class.opacity-50]="isLoading()">
    <table mat-table [dataSource]="dataSource" matSort class="w-full custom-table">

      <!-- Checkbox Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef
          class="!text-left !py-3 !px-4 rounded-tl-xl rounded-bl-xl font-medium text-gray-700">
          <mat-checkbox (change)="masterToggle()" [checked]="isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()" [disabled]="dataSource.filteredData.length === 0 || isLoading() || isBulkDeleting()" class="custom-mat-checkbox">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox (click)="$event.stopPropagation()" (change)="toggleRowSelection(row)"
            [checked]="isSelected(row)" [disabled]="dataSource.filteredData.length === 0 || isLoading() || isBulkDeleting()" class="custom-mat-checkbox"  >
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Patient Number -->
      <ng-container matColumnDef="patientNumber">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Patient #</th>
        <td mat-cell *matCellDef="let row">{{ row.patientNumber }}</td>
      </ng-container>

      <!-- Full Name -->
      <ng-container matColumnDef="fullName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Full Name</th>
        <td mat-cell *matCellDef="let row">
          <span class="primary-text-color hover:underline cursor-pointer" (click)="onEdit(row)">{{ row.fullName }}</span>
        </td>
      </ng-container>

      <!-- Email -->
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
        <td mat-cell *matCellDef="let row">{{ row.email }}</td>
      </ng-container>

      <!-- Mobile Number -->
      <ng-container matColumnDef="phoneNumber">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Mobile</th>
        <td mat-cell *matCellDef="let row">{{ row.phoneNumber }}</td>
      </ng-container>

      <!-- Visit Type -->
      <ng-container matColumnDef="visitTypeName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Visit Type</th>
        <td mat-cell *matCellDef="let row">{{ row.visitTypeName }}</td>
      </ng-container>
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let row">
          <span class="px-2 py-1 rounded-full text-sm font-semibold" [ngClass]="row.status
        ? 'bg-green-100 text-green-800 border border-green-300'
        : 'bg-gray-100 text-gray-600 border border-gray-300'">
            {{ row.status ? 'Active' : 'Inactive' }}
          </span>
        </td>
      </ng-container>

      <!-- Created Date -->
      <ng-container matColumnDef="createdDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Created</th>
        <td mat-cell *matCellDef="let row">{{ row.createdDate | date:'mediumDate' }}</td>
      </ng-container>


      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="text-center rounded-tr-xl rounded-br-xl">Actions</th>
        <td mat-cell *matCellDef="let row" class="text-center">
          <ng-container *ngIf="!isDeleting(); else deleting">
            <button mat-icon-button [matMenuTriggerFor]="actionMenu" [disabled]="isLoading() || isBulkDeleting()">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #actionMenu="matMenu">
              <button mat-menu-item (click)="onEdit(row)">
                <span>Edit</span>
              </button>
              @if (row.status){
                <button mat-menu-item (click)="performAction('deactivate',row)">
                  <span>Deactivate</span>
                </button>
              }
              @else {
                <button mat-menu-item (click)="performAction('activate',row)">
                  <span>Activate</span>
                </button>
              }
              <button mat-menu-item (click)="performAction('delete',row)">
                <span>Delete</span>
              </button>
              <button mat-menu-item (click)="performAction('assign-counsellor',row)">
                <span>Assign Counselor</span>
              </button>
            </mat-menu>
          </ng-container>
          <ng-template #deleting>
            <mat-spinner diameter="20"></mat-spinner>
          </ng-template>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <!-- No Data -->
    <div *ngIf="!isLoading() && dataSource.filteredData.length === 0" class="text-center py-8">
      <mat-icon class="text-gray-400 text-4xl mb-2">person_off</mat-icon>
      <p class="text-gray-500">No patients found.</p>
    </div>
  </div>
<!-- mobile view table card -->
  <div class="mobile-table-wapper pb-4" >
    <ng-container *ngIf="dataSource.filteredData.length > 0">
      <div class="flex items-center gap-2">
        <mat-checkbox (change)="masterToggle()" [checked]="isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()" [disabled]="dataSource.filteredData.length === 0 || isLoading() || isBulkDeleting()" class="custom-mat-checkbox">
        </mat-checkbox>
        <span class="font-bold">Details</span>
      </div>
      <div class="mobile-view-table" *ngFor = "let element of pagedData">
        <div class="toggle-table flex items-center gap-4">
          <div>
            <mat-checkbox (click)="$event.stopPropagation()" (change)="toggleRowSelection(element)"
              [checked]="isSelected(element)" [disabled]="dataSource.filteredData.length === 0 || isLoading() || isBulkDeleting()" class="custom-mat-checkbox"  >
            </mat-checkbox>
          </div>
          <div>
            <p class="m-0"><span class="user-name" (click)="onEdit(element)">{{element.fullName}}</span>({{ element.status ? 'Active' : 'Inactive' }})</p>
            <p class="m-0">{{element.email}}</p>
          </div>
        </div>
        <div>
          <button mat-icon-button [matMenuTriggerFor]="actionMenu" [disabled]="isLoading() || isBulkDeleting()">
              <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #actionMenu="matMenu">
                <button mat-menu-item (click)="onEdit(element)">
                  <span>Edit</span>
                </button>
                @if (element.status){
                  <button mat-menu-item (click)="performAction('deactivate',element)">
                    <span>Deactivate</span>
                  </button>
                }
                @else {
                  <button mat-menu-item (click)="performAction('activate',element)">
                    <span>Activate</span>
                  </button>
                }
                <button mat-menu-item (click)="performAction('delete',element)">
                  <span>Delete</span>
                </button>
                <button mat-menu-item (click)="performAction('assign-counsellor',element)">
                  <span>Assign Counselor</span>
                </button>
              </mat-menu>
        </div>
      </div>
    </ng-container>
    <div *ngIf="!isLoading() && dataSource.filteredData.length === 0" class="text-center py-12">
      <span *ngIf="searchKeyword">No results for "{{searchKeyword}}"</span>
    </div>
  </div>

  <!-- Paginator -->
  <div class="main-paginator">
    <div class="paginator-section p-0">
      <mat-paginator #paginator 
      [pageSizeOptions]="[5, 10, 20, 30]" [pageSize]="5" 
      [showFirstLastButtons]="true" [length]="dataSource.filteredData.length || 0"  [disabled]="isLoading()"  class="mat-mdc-paginator-container disabled:opacity-50">
    </mat-paginator>
    </div>
  </div>
</div>



