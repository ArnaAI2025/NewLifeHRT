<app-patient-navigation-bar [isEditMode]="true" [isSaving]="false" [isActive]="undefined" [patientId]="patientId"
  (close)="onClose()" [activeView]="'shipping-address'" (save)="onSubmit()" (addPatient)="onClickAddPatient()"
  (saveAndClose)="onSaveAndClose()" (toggleActiveStatus)="togglePatientActiveStatus($event)">
</app-patient-navigation-bar>

<div class="card-color rounded-lg shadow-sm border border-gray-200 p-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
      <h2 class="list-page-heading">Shipping Addresses</h2>
      <div class="relative">
        <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
        <input matInput type="text" placeholder="Filter by keywords" [(ngModel)]="searchKeyword" (input)="applyFilter()"
          [disabled]="isLoading()"
          class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 w-64" />
      </div>
    </div>

    <div class="flex items-center gap-4">
      <button mat-flat-button (click)="onAddAddress()" [disabled]="isLoading()"
        class="flex items-center text-blue-600 primary-btn-add">
        <mat-icon class="mr-1">add</mat-icon> Add Address
      </button>

      <!-- Bulk Action Menu -->
      <button type="button" [matMenuTriggerFor]="bulkMenu" [disabled]="getSelectedCount() < 1"
        class="secondry-button-add px-2 rounded-md flex items-center gap-1"
        [ngClass]="{'disabled': getSelectedCount() < 1}">
        <span class="hidden sm:inline">Bulk Action</span>
        <mat-icon>keyboard_arrow_down</mat-icon>
      </button>
      <mat-menu #bulkMenu="matMenu">
        <button mat-menu-item (click)="onBulkToggleActive(true)">Activate</button>
        <button mat-menu-item (click)="onBulkToggleActive(false)">Deactivate</button>
        <button mat-menu-item (click)="onBulkDelete()">Delete</button>
      </mat-menu>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="isLoading()"
    class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 rounded-lg">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Table -->
  <div class="relative overflow-x-auto custom-table-view" [class.opacity-50]="isLoading()"
    [class.pointer-events-none]="isLoading()">
    <table mat-table [dataSource]="dataSource" matSort class="w-full custom-table">
      <!-- Select Checkbox -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef class="!w-16 !pl-6">
          <mat-checkbox (change)="$event ? masterToggle() : null" class="custom-mat-checkbox"
            [checked]="isAllSelected()" [indeterminate]="selection.selected.length && !isAllSelected()"
            [disabled]="dataSource.filteredData.length === 0"></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row" class="!pl-6">
          <mat-checkbox (click)="$event.stopPropagation()" class="custom-mat-checkbox"
            (change)="toggleRowSelection(row)" [checked]="isSelected(row)" [disabled]="isLoading()"></mat-checkbox>
        </td>
      </ng-container>

      <!-- Address -->
      <ng-container matColumnDef="addressLine1">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Address</th>
        <td mat-cell *matCellDef="let row">
          <span class="text-blue-600 hover:underline cursor-pointer" (click)="onEdit(row)">{{ row.addressLine1 }}</span>
        </td>
      </ng-container>

      <!-- City -->
      <ng-container matColumnDef="city">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>City</th>
        <td mat-cell *matCellDef="let row">{{ row.city }}</td>
      </ng-container>

      <!-- Postal Code -->
      <ng-container matColumnDef="postalCode">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Postal Code</th>
        <td mat-cell *matCellDef="let row">{{ row.postalCode }}</td>
      </ng-container>

      <!-- Country -->
      <ng-container matColumnDef="country">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Country</th>
        <td mat-cell *matCellDef="let row">{{ row.country }}</td>
      </ng-container>

      <!-- Status -->
      <ng-container matColumnDef="isActive">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let row">
          <span class="px-2 py-1 rounded-full text-sm font-semibold"
            [ngClass]="row.isActive ? 'bg-green-100 text-green-800 border border-green-300' : 'bg-gray-100 text-gray-600 border border-gray-300'">
            {{ row.isActive ? 'Active' : 'Inactive' }}
          </span>
        </td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="text-center rounded-tr-xl rounded-br-xl">Actions</th>
        <td mat-cell *matCellDef="let row" class="text-center">
          <button mat-icon-button [matMenuTriggerFor]="actionMenu" (click)="activeRow = row"
            [disabled]="isLoading() || isDeleting">
            <mat-icon>more_vert</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns" class="!bg-gray-50/50"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"
        class="hover:bg-gray-50/50 transition-colors !border-b !border-gray-100"></tr>
    </table>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading() && dataSource.filteredData.length === 0" class="text-center py-12">
    <div class="flex flex-col items-center">
      <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-4">
        <mat-icon class="text-gray-400 text-xl">location_off</mat-icon>
      </div>
      <h3 class="text-sm font-medium text-gray-900 mb-1">No shipping addresses found</h3>
    </div>
  </div>
</div>

<!-- Paginator -->
<div class="main-paginator" *ngIf="!isLoading() && dataSource.filteredData.length > 0">
  <div class="paginator-section p-0">
    <mat-paginator #paginator [pageSizeOptions]="[5, 10, 20]" [pageSize]="5" [showFirstLastButtons]="true"
      [length]="dataSource.filteredData.length || 0" [disabled]="isLoading()">
    </mat-paginator>
  </div>
</div>

<!-- Action Menu -->
<mat-menu #actionMenu="matMenu">
  <button mat-menu-item (click)="onEdit(activeRow)">
    <span>Edit</span>
  </button>
  <button mat-menu-item *ngIf="activeRow && !activeRow.isActive" (click)="onToggleActive(activeRow, true)">
    <span>Activate</span>
  </button>
  <button mat-menu-item *ngIf="activeRow && activeRow.isActive" (click)="onToggleActive(activeRow, false)">
    <span>Deactivate</span>
  </button>
  <button mat-menu-item (click)="onDelete(activeRow)" class="text-red-600">
    <span>Delete</span>
  </button>
</mat-menu>

<!-- NEW - Shipping Address Modal -->
<app-shipping-address-add [isVisible]="showAddressModal" [patientId]="patientId!" [shippingAddressId]="editingAddressId"
  (addressCreated)="onAddressCreated($event)" (addressUpdated)="onAddressUpdated($event)"
  (modalClosed)="onAddressModalClosed()">
</app-shipping-address-add>