<!-- Responsive Coupon Management Table -->
<div class="relative">
  <!-- Header with Search and Add -->
  <div class="flex items-center justify-between mb-6 flex-wrap gap-4 mb-6 table-view-header">
    <div class="flex items-center">
      <h1 class="list-page-heading">Coupons Management</h1>
      <div class="flex items-center space-x-3 filter-input search-box search-box-dsk">
        <!-- Search Input -->
        <div class="relative ml-6">
          <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
          <input matInput type="text" placeholder="Filter by keywords" [(ngModel)]="searchKeyword"
            (input)="applyFilter()" [disabled]="isLoading()"
            class="pl-10 text-left pr-4 py-2 border border-gray-300 rounded-md  w-64 disabled:bg-gray-100 disabled:cursor-not-allowed" />
        </div>
      </div>
    </div>


    <div class="flex items-center gap-4 flex-wrap justify-end ml-auto">
      <button mat-flat-button color="primary" [disabled]="isLoading()" (click)="onAddCoupon()" class="primary-btn-add">
        <mat-icon class="mr-2">add</mat-icon> Add Coupon
      </button>

      <!-- Bulk Action Menu -->
      <div class="table-header-group">
        <button type="button" [matMenuTriggerFor]="bulkMenu" [disabled]="getSelectedCount() < 1"
          class="secondry-button-add px-2 rounded-md flex items-center gap-1"
          [ngClass]="{'disabled': getSelectedCount() < 1}">
          <span class="hidden sm:inline">Bulk Action</span>
          <mat-icon>keyboard_arrow_down</mat-icon>
        </button>
        <mat-menu #bulkMenu="matMenu">
          <button mat-menu-item (click)="onBulkToggleActive(true)">Activate</button>
          <button mat-menu-item (click)="onBulkToggleActive(false)">Deactivate</button>
          <button mat-menu-item (click)="onBulkDelete()">Delete</button>
        </mat-menu>
      </div>
      <div class="flex items-center space-x-3 w-full filter-input search-box-mb">
        <!-- Search Input -->
        <div class="relative">
          <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
          <input matInput type="text" placeholder="Filter by keywords" [(ngModel)]="searchKeyword"
            (input)="applyFilter()" [disabled]="isLoading()"
            class="pl-10 text-left pr-4 py-2 border border-gray-300 rounded-md w-full bg-transparent disabled:bg-transparent disabled:opacity-50 disabled:cursor-not-allowed !bg-transparent" />
        </div>
      </div>
    </div>
  </div>

  <!-- Table Section -->
  <div class="table-container custom-table-view" [class.opacity-50]="isLoading()">
    <table mat-table [dataSource]="dataSource" matSort class="w-full custom-table mat-elevation-z0">

      <!-- Select Checkbox -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef class=" !text-left !py-3 !px-4 rounded-tl-lg rounded-bl-lg
          font-medium text-gray-700">
          <mat-checkbox (change)="masterToggle()" class="custom-mat-checkbox" [checked]="isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()"
            [disabled]="dataSource.filteredData.length === 0">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox (click)="$event.stopPropagation()" class="custom-mat-checkbox"
            (change)="toggleRowSelection(row)" [checked]="isSelected(row)">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Coupon Name -->
      <ng-container matColumnDef="couponName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Coupon Name</th>
        <td mat-cell *matCellDef="let row">
          <span class="primary-text-color hover:underline cursor-pointer" (click)="onEdit(row)">
            {{ row.couponName }}
          </span>
        </td>
      </ng-container>

      <!-- Counselor -->
      <ng-container matColumnDef="counselorName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>User</th>
        <td mat-cell *matCellDef="let row"> {{ row.counselorName || '-' }} </td>
      </ng-container>

      <!-- Expiry Date -->
      <ng-container matColumnDef="expiryDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Expiry Date</th>
        <td mat-cell *matCellDef="let row">{{ row.expiryDate | date:'shortDate' }}</td>
      </ng-container>

      <!-- Amount -->
      <ng-container matColumnDef="amount">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
        <td mat-cell *matCellDef="let row">{{ row.amount | currency }}</td>
      </ng-container>

      <!-- Percentage -->
      <ng-container matColumnDef="percentage">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Percentage</th>
        <td mat-cell *matCellDef="let row">
          {{ row.percentage != null ? (row.percentage + '%') : '-' }}
        </td>
      </ng-container>

      <!-- Status -->
      <ng-container matColumnDef="isActive">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let row">
          <span class="px-2 py-1 rounded-full text-sm font-semibold" [ngClass]="row.isActive ? 'bg-green-100 text-green-800 border border-green-300'
                                         : 'bg-gray-100 text-gray-600 border border-gray-300'">
            {{ row.isActive ? 'Active' : 'Inactive' }}
          </span>
        </td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef
          class="!text-left !py-3 !px-4 !bg-gray-50 font-medium text-gray-700 border-opacity-0 table-right-corner">
          Actions</th>
        <td mat-cell *matCellDef="let row">
          <button mat-icon-button [matMenuTriggerFor]="actionMenu" (click)="selectedRow.set(row)">
            <mat-icon>more_vert</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  </div>

  <!-- No Data -->
    <div class="text-center py-8 " *ngIf="!dataSource.filteredData.length && !isLoading()">
      <mat-icon class="text-gray-400 text-4xl mb-2">person_off</mat-icon>
      <p class="text-gray-500" *ngIf="searchKeyword">No results for "{{searchKeyword}}"</p>
      <p class="text-gray-500" *ngIf="!searchKeyword">No coupon data available</p>
    </div>

    <!-- mobile view table card -->
    <div class="mobile-table-wapper pb-4">
      <ng-container *ngIf="dataSource.filteredData.length > 0">
        <div class="flex items-center gap-2">
          <mat-checkbox class="custom-mat-checkbox" (change)="$event ? masterToggle() : null" [checked]="isAllSelected()"
                [indeterminate]="selection.hasValue() && !isAllSelected()"></mat-checkbox>
          <span class="font-bold">Details</span>
        </div>
        <div class="mobile-view-table" *ngFor = "let element of pagedData">
          <div class="toggle-table flex items-center gap-4">
            <div>
              <mat-checkbox class="custom-mat-checkbox" (change)="toggleRowSelection(element)" [checked]="isSelected(element)" [disabled]="isLoading()"></mat-checkbox>
            </div>
            <div>
              <p class="m-0"><span class="user-name" (click)="onEdit(element)">{{element.couponName}}</span><span>({{ element.isActive ? 'Active' : 'Inactive' }})</span></p>
              <p class="m-0">{{element.amount}}</p>
              <p class="m-0">{{ element.expiryDate | date:'shortDate' }}</p>
            </div>
          </div>
          <div>
            <button mat-icon-button [matMenuTriggerFor]="actionMenu" (click)="selectedRow.set(element)">
              <mat-icon>more_vert</mat-icon>
            </button>
          </div>
        </div>
      </ng-container>
    </div>

  <!-- Paginator -->
    <div class="main-paginator">
        <div class="paginator-section p-0">
            <mat-paginator #paginator [pageSizeOptions]="[50, 100, 250, 500]" [pageSize]="100" [showFirstLastButtons]="true"
                [length]="dataSource.filteredData.length || 0" [disabled]="isLoading()"
                class="mat-mdc-paginator-container">
            </mat-paginator>
        </div>
    </div>
</div>

<!-- Action Menu -->
<mat-menu #actionMenu="matMenu">
  <button mat-menu-item (click)="selectedRow() && onEdit(selectedRow())">Edit</button>
  <button mat-menu-item (click)="selectedRow() && onToggleActive(selectedRow(), !selectedRow()?.isActive)">
    {{ selectedRow()?.isActive ? 'Deactivate' : 'Activate' }}
  </button>
  <button mat-menu-item (click)="selectedRow() && onDelete(selectedRow())">Delete</button>
</mat-menu>
