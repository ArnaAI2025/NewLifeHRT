<app-patient-navigation-bar *ngIf="patientId" [isEditMode]="true" [isSaving]="false" [isActive]="undefined"
  [patientId]="patientId" (close)="onClose()" [activeView]="'reminders'" (save)="onSubmit()"
  (addPatient)="onClickAddPatient()" (saveAndClose)="onSaveAndClose()"
  (toggleActiveStatus)="togglePatientActiveStatus($event)">
</app-patient-navigation-bar>

<app-lead-navigation-bar *ngIf="leadId" [leadId]="leadId" [isEditMode]="true" [isSaving]="false" (close)="onClose()"
  [activeView]="'reminders'" (save)="onSubmit()" (addLead)="onClickAddLead()" (saveAndClose)="onSaveAndClose()"
  (toggleActiveStatus)="toggleLeadActiveStatus($event)">
</app-lead-navigation-bar>

<app-full-page-loader [visible]="isLoading()" />

<div [formGroup]="reminderForm" class="bg-white rounded-lg shadow-sm border border-gray-200 bg-card-color">
  <div class="p-5 sm:p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-6 uppercase tracking-wide">Reminder Details</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Reminder Date Time -->
      <div class="space-y-2 custom-text-box">
        <label class="block text-sm font-medium text-gray-700">
          Reminder Date Time <span class="text-red-500">*</span>
        </label>
        <div class="flex gap-4">
          <!-- Date Picker -->
          <mat-form-field appearance="outline" class="w-1/2 form-input form-input-text">
            <input matInput [matDatepicker]="picker" formControlName="reminderDate" placeholder="Select date"
              (dateChange)="onDateSelected()">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>

          <!-- Time Picker -->
          <mat-form-field appearance="outline" class="w-1/2 form-input form-input-text">
            <input matInput [ngxMatTimepicker]="timePicker" formControlName="reminderTime" placeholder="Select time"
              (ngxMatTimepickerChange)="onTimeSelected()">
            <ngx-mat-timepicker-toggle [for]="timePicker" matSuffix></ngx-mat-timepicker-toggle>
            <ngx-mat-timepicker #timePicker></ngx-mat-timepicker>
          </mat-form-field>
        </div>
        @if (reminderForm.get('reminderDateTime')?.invalid && reminderForm.get('reminderDateTime')?.touched) {
        <div class="text-red-500 text-xs mt-1">Reminder date and time is required</div>
        }
      </div>

      <!-- Reminder Type Dropdown -->
      <div class="space-y-2 custom-text-box">
        <label class="block text-sm font-medium text-gray-700">
          Reminder Type <span class="text-red-500">*</span>
        </label>
        <mat-form-field appearance="outline" class="w-full form-input form-input-text">
          <mat-select formControlName="reminderTypeId" placeholder="Select Reminder Type">
            @for(type of reminderTypes(); track type.id) {
            <mat-option [value]="type.id">{{ type.typeName }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
        @if (reminderForm.get('reminderTypeId')?.invalid && reminderForm.get('reminderTypeId')?.touched) {
        <div class="text-red-500 text-xs mt-1">Reminder type is required</div>
        }
      </div>
    </div>

    <!-- Recurrence Checkbox and Rules -->
    <div class="mt-6 space-y-4">
      <mat-checkbox formControlName="isRecurring" class="block custom-mat-checkbox">
        Recurrence
      </mat-checkbox>

      @if (reminderForm.get('isRecurring')?.value) {
      <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
        <label class="block text-sm font-medium text-gray-700 mb-3">
          Recurrence Rules <span class="text-red-500">*</span>
        </label>
        <div class="flex flex-wrap gap-4">
          @for(rule of recurrenceRules(); track rule.id) {
          <label class="flex items-center space-x-2">
            <input type="radio" [value]="rule.id" formControlName="recurrenceRuleId" class="primary-color-radio">
            <span class="text-sm text-gray-700">{{ rule.ruleName }}</span>
          </label>
          }
        </div>
        @if (reminderForm.get('recurrenceRuleId')?.invalid && reminderForm.get('recurrenceRuleId')?.touched) {
        <div class="text-red-500 text-xs mt-2">Recurrence rule is required when recurrence is enabled</div>
        }

        <!-- Recurrence End Date -->
        <div class="mt-4 space-y-2">
          <label class="block text-sm font-medium text-gray-700">
            Recurrence End Date <span class="text-red-500">*</span>
          </label>
          <mat-form-field appearance="outline">
            <input matInput [matDatepicker]="endDatePicker" formControlName="recurrenceEndDateTime"
             placeholder="Select end date">
            <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #endDatePicker></mat-datepicker>
          </mat-form-field>
        </div>
      </div>
      }
    </div>

    <!-- Description -->
    <div class="mt-6 space-y-2 custom-text-box">
      <label class="block text-sm font-medium text-gray-700">Description (Optional)</label>
      <mat-form-field appearance="outline" class="w-full form-des-input">
        <textarea matInput formControlName="description" placeholder="Add reminder description" rows="4"></textarea>
      </mat-form-field>
    </div>

    <!-- Submit Button -->
    <div class="flex justify-end space-x-2 p-6 pt-0 mt-6">
      <button type="button" mat-flat-button class="primary-btn-add" [ngClass]="{'disabled': reminderForm.invalid}"
        (click)="onSubmitReminder()" [disabled]="reminderForm.invalid || isLoading()">
        {{ isLoading() ? 'Creating...' : 'Create' }}
      </button>
    </div>
  </div>
</div>
